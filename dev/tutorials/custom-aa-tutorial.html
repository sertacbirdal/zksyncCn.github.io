<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>账户抽象 | zkSync — Accelerating the mass adoption of crypto for personal sovereignty</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script src="/__/firebase/7.13.2/firebase-app.js" defer="true"></script>
    <script src="/__/firebase/7.13.2/firebase-analytics.js" defer="true"></script>
    <script src="/__/firebase/init.js" defer="true"></script>
    <script>
  const logoUrlChanger = setInterval(function() {
    //Anchor above the logo image
    const homeEls = document.getElementsByClassName("home-link");
    if(homeEls.length > 0) {
      const homeEl = homeEls[0];
      homeEl.setAttribute("href", "https://zksync.io");
      homeEl.setAttribute("onclick", "document.location='https://zksync.io';return false;");
      clearInterval(logoUrlChanger);
    }

    //Actual logo image
    const logoEls = document.getElementsByClassName("logo")
    if(logoEls.length > 0) {
      const logoEl = logoEls[0]
      logoEl.setAttribute("onclick", "document.location='https://zksync.io';return false;");
      clearInterval(logoUrlChanger);
    }
  }, 1000)</script>
    <meta name="description" content="zkSync is a ZK rollup that represents the end-game for scaling Ethereum - one that scales its technology and values without degrading security or decentralization">
    
    <link rel="preload" href="/assets/css/0.styles.350a0b01.css" as="style"><link rel="preload" href="/assets/js/app.c05cfcc8.js" as="script"><link rel="preload" href="/assets/js/2.5a73362d.js" as="script"><link rel="preload" href="/assets/js/73.c6b3bb28.js" as="script"><link rel="prefetch" href="/assets/js/10.1d31b665.js"><link rel="prefetch" href="/assets/js/11.1babd81e.js"><link rel="prefetch" href="/assets/js/12.6a0fb8cc.js"><link rel="prefetch" href="/assets/js/13.fee8f0c2.js"><link rel="prefetch" href="/assets/js/14.0c7cfd9a.js"><link rel="prefetch" href="/assets/js/15.a0dce9fd.js"><link rel="prefetch" href="/assets/js/16.194f569d.js"><link rel="prefetch" href="/assets/js/17.5519ba2b.js"><link rel="prefetch" href="/assets/js/18.60014d7f.js"><link rel="prefetch" href="/assets/js/19.fdcd15af.js"><link rel="prefetch" href="/assets/js/20.29c80189.js"><link rel="prefetch" href="/assets/js/21.cbfdc048.js"><link rel="prefetch" href="/assets/js/22.a47ff286.js"><link rel="prefetch" href="/assets/js/23.d7ed71bc.js"><link rel="prefetch" href="/assets/js/24.81c68be0.js"><link rel="prefetch" href="/assets/js/25.afe0dc2b.js"><link rel="prefetch" href="/assets/js/26.0abc39fe.js"><link rel="prefetch" href="/assets/js/27.c3936ac3.js"><link rel="prefetch" href="/assets/js/28.e95190d8.js"><link rel="prefetch" href="/assets/js/29.61f46d4c.js"><link rel="prefetch" href="/assets/js/3.073d186a.js"><link rel="prefetch" href="/assets/js/30.4f0c89bb.js"><link rel="prefetch" href="/assets/js/31.e218f05f.js"><link rel="prefetch" href="/assets/js/32.cc8aa65b.js"><link rel="prefetch" href="/assets/js/33.e257bee1.js"><link rel="prefetch" href="/assets/js/34.54d63fbb.js"><link rel="prefetch" href="/assets/js/35.c69d2ca4.js"><link rel="prefetch" href="/assets/js/36.d86e7687.js"><link rel="prefetch" href="/assets/js/37.236b4615.js"><link rel="prefetch" href="/assets/js/38.0c8a016e.js"><link rel="prefetch" href="/assets/js/39.2b1ae14e.js"><link rel="prefetch" href="/assets/js/4.405af041.js"><link rel="prefetch" href="/assets/js/40.22803ea2.js"><link rel="prefetch" href="/assets/js/41.729c9834.js"><link rel="prefetch" href="/assets/js/42.4d37c627.js"><link rel="prefetch" href="/assets/js/43.8463b35b.js"><link rel="prefetch" href="/assets/js/44.e605a149.js"><link rel="prefetch" href="/assets/js/45.f5cc65a1.js"><link rel="prefetch" href="/assets/js/46.040c3b33.js"><link rel="prefetch" href="/assets/js/47.1742c2e6.js"><link rel="prefetch" href="/assets/js/48.0a8fd426.js"><link rel="prefetch" href="/assets/js/49.1f4068ca.js"><link rel="prefetch" href="/assets/js/5.7bae62cf.js"><link rel="prefetch" href="/assets/js/50.c38bb825.js"><link rel="prefetch" href="/assets/js/51.9bfc556b.js"><link rel="prefetch" href="/assets/js/52.5a41b52d.js"><link rel="prefetch" href="/assets/js/53.b3c9e0f7.js"><link rel="prefetch" href="/assets/js/54.f5e00505.js"><link rel="prefetch" href="/assets/js/55.531d5c7a.js"><link rel="prefetch" href="/assets/js/56.fe219180.js"><link rel="prefetch" href="/assets/js/57.4e54910c.js"><link rel="prefetch" href="/assets/js/58.c7f14b85.js"><link rel="prefetch" href="/assets/js/59.bfe610be.js"><link rel="prefetch" href="/assets/js/6.a5466f63.js"><link rel="prefetch" href="/assets/js/60.7a2131e7.js"><link rel="prefetch" href="/assets/js/61.ed3ce206.js"><link rel="prefetch" href="/assets/js/62.2de7f05e.js"><link rel="prefetch" href="/assets/js/63.bb5f1763.js"><link rel="prefetch" href="/assets/js/64.ebd6db8c.js"><link rel="prefetch" href="/assets/js/65.c3e962c7.js"><link rel="prefetch" href="/assets/js/66.95aa148c.js"><link rel="prefetch" href="/assets/js/67.307f17c1.js"><link rel="prefetch" href="/assets/js/68.025e563f.js"><link rel="prefetch" href="/assets/js/69.d0b067fb.js"><link rel="prefetch" href="/assets/js/7.9cb55bb9.js"><link rel="prefetch" href="/assets/js/70.3fa22b2f.js"><link rel="prefetch" href="/assets/js/71.2b32dd42.js"><link rel="prefetch" href="/assets/js/72.6d871cf8.js"><link rel="prefetch" href="/assets/js/74.5d63dfe9.js"><link rel="prefetch" href="/assets/js/75.c07a7760.js"><link rel="prefetch" href="/assets/js/76.685eb63e.js"><link rel="prefetch" href="/assets/js/8.f9eaafb5.js"><link rel="prefetch" href="/assets/js/9.2e9fb4a6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.350a0b01.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/LogotypeLight.svg" alt="zkSync — Accelerating the mass adoption of crypto for personal sovereignty" class="logo"> <span class="site-name can-hide">zkSync — Accelerating the mass adoption of crypto for personal sovereignty</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/dev/" class="nav-link router-link-active">
  开发文档
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  工具/SDK
</a></div><div class="nav-item"><a href="/contact.html" class="nav-link">
  联系我们
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="v2.0" class="dropdown-title"><span class="title">v2.0</span> <span class="arrow down"></span></button> <button type="button" aria-label="v2.0" class="mobile-dropdown-title"><span class="title">v2.0</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/dev/" class="nav-link router-link-active">
  v2.0
</a></li><li class="dropdown-item"><!----> <a href="https://docs.zksync.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v1.x
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/matter-labs/zksync-web-v2-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/dev/" class="nav-link router-link-active">
  开发文档
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  工具/SDK
</a></div><div class="nav-item"><a href="/contact.html" class="nav-link">
  联系我们
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="v2.0" class="dropdown-title"><span class="title">v2.0</span> <span class="arrow down"></span></button> <button type="button" aria-label="v2.0" class="mobile-dropdown-title"><span class="title">v2.0</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/dev/" class="nav-link router-link-active">
  v2.0
</a></li><li class="dropdown-item"><!----> <a href="https://docs.zksync.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v1.x
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/matter-labs/zksync-web-v2-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/dev/" aria-current="page" class="sidebar-link">介绍</a></li><li><section class="sidebar-group depth-0"><a href="/dev/fundamentals" class="sidebar-heading clickable"><span>开始</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/fundamentals/rollups.html" class="sidebar-link">rollups 介绍</a></li><li><a href="/dev/fundamentals/zkSync.html" class="sidebar-link">zkSync 基础知识</a></li><li><a href="/dev/fundamentals/testnet.html" class="sidebar-link">zkSync 测试网</a></li><li><a href="/dev/fundamentals/faq.html" class="sidebar-link">FAQ</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/dev/developer-guides" class="sidebar-heading clickable"><span>关于zkSync</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/developer-guides/transactions/transactions.html" class="sidebar-link">交易</a></li><li><a href="/dev/developer-guides/transactions/blocks.html" class="sidebar-link">区块</a></li><li><a href="/dev/developer-guides/contracts/system-contracts.html" class="sidebar-link">系统合约</a></li><li><a href="/dev/developer-guides/aa.html" class="sidebar-link">账户抽象支持</a></li><li><a href="/dev/developer-guides/security.html" class="sidebar-link">安全模型</a></li><li><a href="/dev/developer-guides/transactions/fee-model.html" class="sidebar-link">费用机制</a></li><li><a href="/dev/developer-guides/bridging/bridging-asset.html" class="sidebar-link">桥接资产</a></li><li><a href="/dev/developer-guides/bridging/l1-l2-interop.html" class="sidebar-link">L1 / L2 的互操作性</a></li><li><a href="/dev/developer-guides/bridging/l1-l2.html" class="sidebar-link">L1 -&gt; L2 通信</a></li><li><a href="/dev/developer-guides/bridging/l2-l1.html" class="sidebar-link">L2 -&gt; L1 通信</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/dev/developer-guides/building-on-zksync" class="sidebar-heading clickable"><span>在zkSync上构建</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/developer-guides/hello-world.html" class="sidebar-link">Quickstart</a></li><li><a href="/dev/developer-guides/contracts/contracts.html" class="sidebar-link">合约部署</a></li><li><a href="/dev/developer-guides/contracts/contract-verification.html" class="sidebar-link">验证智能合约</a></li><li><a href="/dev/developer-guides/building-on-zksync/events.html" class="sidebar-link">处理事件</a></li><li><a href="/dev/developer-guides/building-on-zksync/rpc.html" class="sidebar-link">JSON-RPC API</a></li><li><a href="/dev/developer-guides/building-on-zksync/videos.html" class="sidebar-link">视频资源</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/dev/tutorials" class="sidebar-heading clickable router-link-active open"><span>教程</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/tutorials/cross-chain-tutorial.html" class="sidebar-link">跨链治理</a></li><li><a href="/dev/tutorials/custom-aa-tutorial.html" aria-current="page" class="active sidebar-link">账户抽象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dev/tutorials/custom-aa-tutorial.html#先决条件" class="sidebar-link">先决条件</a></li><li class="sidebar-sub-header"><a href="/dev/tutorials/custom-aa-tutorial.html#安装依赖项" class="sidebar-link">安装依赖项</a></li><li class="sidebar-sub-header"><a href="/dev/tutorials/custom-aa-tutorial.html#账户抽象-2" class="sidebar-link">账户抽象</a></li><li class="sidebar-sub-header"><a href="/dev/tutorials/custom-aa-tutorial.html#代理" class="sidebar-link">代理</a></li><li class="sidebar-sub-header"><a href="/dev/tutorials/custom-aa-tutorial.html#部署代理" class="sidebar-link">部署代理</a></li><li class="sidebar-sub-header"><a href="/dev/tutorials/custom-aa-tutorial.html#使用账户" class="sidebar-link">使用账户</a></li><li class="sidebar-sub-header"><a href="/dev/tutorials/custom-aa-tutorial.html#完成项目" class="sidebar-link">完成项目</a></li><li class="sidebar-sub-header"><a href="/dev/tutorials/custom-aa-tutorial.html#learn-more" class="sidebar-link">Learn more</a></li></ul></li><li><a href="/dev/tutorials/custom-paymaster-tutorial.html" class="sidebar-link">建立自定义 paymaster</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/dev/troubleshooting" class="sidebar-heading clickable"><span>错误排除</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/troubleshooting/important-links.html" class="sidebar-link">Important links</a></li><li><a href="/dev/troubleshooting/status.html" class="sidebar-link">Feature support status</a></li><li><a href="/dev/troubleshooting/docs-contribution/docs.html" class="sidebar-link">文档贡献指南</a></li><li><a href="/dev/troubleshooting/docs-contribution/community-resources.html" class="sidebar-link">Community resources</a></li><li><a href="/dev/troubleshooting/known-issues.html" class="sidebar-link">Known issues</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="账户抽象"><a href="#账户抽象" class="header-anchor">#</a> 账户抽象</h1> <p>现在，让我们学习如何部署自定义账户并直接与 <a href="/dev/developer-guides/contracts/system-contracts.html#contractdeployer">ContractDeployer</a> 系统合约交互。
在本教程中，我们构建了一个部署 2-of-2 多重签名帐户的工厂。</p> <h2 id="先决条件"><a href="#先决条件" class="header-anchor">#</a> 先决条件</h2> <p>强烈建议在深入学习本教程之前阅读账户抽象协议的<a href="/dev/developer-guides/aa.html">设计</a>。</p> <p>假设您已经熟悉在 zkSync 上部署智能合约。
如果没有，请参考<a href="/dev/developer-guides/hello-world.html">快速入门</a>。
还建议阅读系统合约的<a href="/dev/developer-guides/contracts/system-contracts.html">介绍</a>。</p> <h2 id="安装依赖项"><a href="#安装依赖项" class="header-anchor">#</a> 安装依赖项</h2> <p>我们将使用 zkSync hardhat 插件来开发这个合约。 首先，我们应该为它安装所有依赖项：</p> <div class="language- extra-class"><pre class="language-text"><code>mkdir custom-aa-tutorial
cd custom-aa-tutorial
yarn init -y
yarn add -D typescript ts-node ethers zksync-web3 hardhat @matterlabs/hardhat-zksync-solc @matterlabs/hardhat-zksync-deploy
</code></pre></div><p>由于我们正在使用 zkSync 合约，我们还需要安装包含合约和对等依赖项的包：</p> <div class="language- extra-class"><pre class="language-text"><code>yarn add @matterlabs/zksync-contracts @openzeppelin/contracts @openzeppelin/contracts-upgradeable
</code></pre></div><p>此外，需要创建 <code>hardhat.config.ts</code> 配置文件、<code>contracts</code> 和 <code>deploy</code> 文件夹，就像在 <a href="/dev/developer-guides/hello-world.html">快速入门教程</a> 中一样。</p> <h2 id="账户抽象-2"><a href="#账户抽象-2" class="header-anchor">#</a> 账户抽象</h2> <p>每个账号都需要实现<a href="/dev/developer-guides/aa.html#iaccount-interface">IAccount</a>接口。 由于我们正在与签名者建立一个帐户，因此我们还应该实施 <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/83277ff916ac4f58fec072b8f28a252c1245c2f1/contracts/interfaces/IERC1271.sol#L12" target="_blank" rel="noopener noreferrer">EIP1271<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>合同的框架将如下所示：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token comment">// SPDX-License-Identifier: MIT</span>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">'@matterlabs/zksync-contracts/l2/system-contracts/interfaces/IAccount.sol'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'@matterlabs/zksync-contracts/l2/system-contracts/TransactionHelper.sol'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">&quot;@openzeppelin/contracts/interfaces/IERC1271.sol&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">TwoUserMultisig</span> <span class="token keyword">is</span> IAccount<span class="token punctuation">,</span> IERC1271 <span class="token punctuation">{</span>

    <span class="token keyword">modifier</span> <span class="token function">onlyBootloader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> BOOTLOADER_FORMAL_ADDRESS<span class="token punctuation">,</span> <span class="token string">&quot;Only bootloader can call this method&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Continure execution if called from the bootloader.</span>
        <span class="token keyword">_</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">validateTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span> _suggestedSignedHash<span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        <span class="token function">_validateTransaction</span><span class="token punctuation">(</span>_suggestedSignedHash<span class="token punctuation">,</span> _transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">_validateTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _suggestedSignedHash<span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">executeTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">executeTransactionFromOutside</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span>
        <span class="token function">_validateTransaction</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

      <span class="token builtin">bytes4</span> <span class="token keyword">constant</span> EIP1271_SUCCESS_RETURN_VALUE <span class="token operator">=</span> <span class="token number">0x1626ba7e</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">isValidSignature</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _hash<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> _signature<span class="token punctuation">)</span> <span class="token keyword">public</span> override <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> EIP1271_SUCCESS_RETURN_VALUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">payForTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">prePaymaster</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

      <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span>
        <span class="token comment">// If the bootloader called the `receive` function, it likely means</span>
        <span class="token comment">// that something went wrong and the transaction should be aborted. The bootloader should</span>
        <span class="token comment">// only interact through the `validateTransaction`/`executeTransaction` methods.</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">!=</span> BOOTLOADER_FORMAL_ADDRESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>请注意，只有 <a href="/dev/developer-guides/contracts/system-contracts.html#bootloader">bootloader</a> 被允许调用 <code>validateTransaction</code>/<code>executeTransaction</code>/<code>payForTransaction</code>/<code>prePaymaster</code> 。这是使用 <code>onlyBootloader</code> 修饰符的原因。</p> <p>需要 <code>executeTransactionFromOutside</code> 允许外部用户从此帐户发起交易。 实现它的最简单方法是执行与 validateTransaction + executeTransaction 相同的操作。</p> <h3 id="签名验证"><a href="#签名验证" class="header-anchor">#</a> 签名验证</h3> <p>首先，我们需要实现签名验证过程。 由于我们正在构建一个双账户多重签名，因此让我们在构造函数中传递其所有者的地址。 在本教程中，我们使用 OpenZeppelin 的“ECDSA”库进行签名验证。</p> <p>添加以下导入：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">import</span> <span class="token string">&quot;@openzeppelin/contracts/utils/cryptography/ECDSA.sol&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>另外，将构造函数添加到合约中：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token builtin">address</span> <span class="token keyword">public</span> owner1<span class="token punctuation">;</span>
<span class="token builtin">address</span> <span class="token keyword">public</span> owner2<span class="token punctuation">;</span>

<span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _owner1<span class="token punctuation">,</span> <span class="token builtin">address</span> _owner2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    owner1 <span class="token operator">=</span> _owner1<span class="token punctuation">;</span>
    owner2 <span class="token operator">=</span> _owner2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后我们可以通过以下方式实现 isValidSignature 方法：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">isValidSignature</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _hash<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> _signature<span class="token punctuation">)</span> <span class="token keyword">public</span> override <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The signature is the concatenation of the ECDSA signatures of the owners</span>
    <span class="token comment">// Each ECDSA signature is 65 bytes long. That means that the combined signature is 130 bytes long.</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>_signature<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">130</span><span class="token punctuation">,</span> <span class="token string">'Signature length is incorrect'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">address</span> recoveredAddr1 <span class="token operator">=</span> ECDSA<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>_hash<span class="token punctuation">,</span> _signature<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">address</span> recoveredAddr2 <span class="token operator">=</span> ECDSA<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>_hash<span class="token punctuation">,</span> _signature<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">:</span><span class="token number">130</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">require</span><span class="token punctuation">(</span>recoveredAddr1 <span class="token operator">==</span> owner1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>recoveredAddr2 <span class="token operator">==</span> owner2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> EIP1271_SUCCESS_RETURN_VALUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="交易验证"><a href="#交易验证" class="header-anchor">#</a> 交易验证</h3> <p>接下来让我们实现验证过程。它负责验证交易的签名并增加随机数。 请注意，此方法允许执行的操作有一些限制。 您可以 <a href="/dev/developer-guides/aa.html#limitations-of-the-verification-step">此处</a> 阅读更多相关信息。</p> <p>要增加随机数，您应该使<code>NONCE_HOLDER_SYSTEM_CONTRACT</code> 系统合约的<code>incrementNonceIfEquals</code> 方法。 它获取交易随机数并检查随机数是否与提供的随机数相同。 如果不是，则交易恢复。 否则，随机数增加。</p> <p>尽管上述要求只允许帐户访问其存储槽，但在<code>NONCE_HOLDER_SYSTEM_CONTRACT</code>中访问您的随机数是 [白名单](../developer-guides/aa.md#extending-the-set-of-slots- that-belong-to-a-user) 案例，因为它的行为方式与您的存储相同，所以它恰好在另一个合同中。 要调用 <code>NONCE_HOLDER_SYSTEM_CONTRACT</code>，您应该添加以下导入：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">import</span> <span class="token string">'@matterlabs/zksync-contracts/l2/system-contracts/Constants.sol'</span><span class="token punctuation">;</span>
</code></pre></div><p><code>TransactionHelper</code> 库（已在上面的示例中导入）可用于获取应签署的交易的哈希值。 您也可以实现自己的签名方案并使用不同的承诺对交易进行签名，但在本例中我们使用该库提供的哈希。</p> <p>使用 <code>TransactionHelper</code> 库：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">using</span> <span class="token class-name">TransactionHelper</span> <span class="token keyword">for</span> Transaction<span class="token punctuation">;</span>
</code></pre></div><p>另外，请注意，由于需要在打开 isSystem 标志的情况下调用 <code>NONCE_HOLDER_SYSTEM_CONTRACT</code> 非视图方法，因此 [systemCall](https://github.com/matter-labs/v2-testnet-contracts /blob/a3cd3c557208f2cd18e12c41840c5d3728d7f71b/l2/system-contracts/SystemContractsCaller.sol#L55) 应该使用<code>SystemContractsCaller</code> 库方法，所以这个库也需要导入：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">import</span> <span class="token string">'@matterlabs/zksync-contracts/l2/system-contracts/SystemContractsCaller.sol'</span><span class="token punctuation">;</span>
</code></pre></div><p>现在我们可以实现 _validateTransaction 方法：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">_validateTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _suggestedSignedHash<span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    <span class="token comment">// Incrementing the nonce of the account.</span>
    <span class="token comment">// Note, that reserved[0] by convention is currently equal to the nonce passed in the transaction</span>
    SystemContractsCaller<span class="token punctuation">.</span><span class="token function">systemCall</span><span class="token punctuation">(</span>
        <span class="token builtin">uint32</span><span class="token punctuation">(</span><span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token builtin">address</span><span class="token punctuation">(</span>NONCE_HOLDER_SYSTEM_CONTRACT<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span>INonceHolder<span class="token punctuation">.</span>incrementMinNonceIfEquals<span class="token punctuation">,</span> <span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">bytes32</span> txHash<span class="token punctuation">;</span>
    <span class="token comment">// While the suggested signed hash is usually provided, it is generally</span>
    <span class="token comment">// not recommended to rely on it to be present, since in the future</span>
    <span class="token comment">// there may be tx types with no suggested signed hash.</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>_suggestedSignedHash <span class="token operator">==</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        txHash <span class="token operator">=</span> _transaction<span class="token punctuation">.</span><span class="token function">encodeHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        txHash <span class="token operator">=</span> _suggestedSignedHash<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">isValidSignature</span><span class="token punctuation">(</span>txHash<span class="token punctuation">,</span> _transaction<span class="token punctuation">.</span>signature<span class="token punctuation">)</span> <span class="token operator">==</span> EIP1271_SUCCESS_RETURN_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="支付交易费用"><a href="#支付交易费用" class="header-anchor">#</a> 支付交易费用</h3> <p>我们现在应该实现 <code>payForTransaction</code> 方法。 <code>TransactionHelper</code> 库已经为我们提供了<code>payToTheBootloader</code> 方法，该方法将<code>_transaction.maxFeePerErg * _transaction.ergsLimit</code> ETH 发送到引导加载程序。 所以实现相当简单：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">payForTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        <span class="token builtin">bool</span> success <span class="token operator">=</span> _transaction<span class="token punctuation">.</span><span class="token function">payToTheBootloader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">&quot;Failed to pay the fee to the operator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="实施prepaymaster"><a href="#实施prepaymaster" class="header-anchor">#</a> 实施<code>prePaymaster</code></h3> <p>虽然通常账户抽象协议允许与付款人交互时执行任意操作，但有一些是来自<a href="/dev/developer-guides/aa.html#built-in-paymaster-flows">常见模式</a> 的内置支持 EOA。
除非您想从您的帐户中实施或限制某些特定的付款人用例，否则最好使其与 EOA 保持一致。 <code>TransactionHelper</code> 库提供了 <code>processPaymasterInput</code>，它正是这样做的：像 EOA 一样处理 <code>prePaymaster</code> 步骤。</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">prePaymaster</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
    _transaction<span class="token punctuation">.</span><span class="token function">processPaymasterInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="交易执行"><a href="#交易执行" class="header-anchor">#</a> 交易执行</h3> <p>交易执行的最基本实现非常简单：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint256</span> to <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>to<span class="token punctuation">;</span>
    <span class="token comment">// By convention, the `reserved[1]` field is msg.value</span>
    <span class="token builtin">uint256</span> value <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> data <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

    <span class="token builtin">bool</span> success<span class="token punctuation">;</span>
    <span class="token keyword">assembly</span> <span class="token punctuation">{</span>
        success <span class="token operator">:=</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token function">gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mload</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Needed for the transaction to be correctly processed by the server.</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>但是，请注意，调用 ContractDeployer 只能使用 isSystem 调用标志。 为了允许您的用户部署合约，您应该明确地这样做：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    <span class="token builtin">address</span> to <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token builtin">uint160</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> value <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> data <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>to <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span>DEPLOYER_SYSTEM_CONTRACT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We allow calling ContractDeployer with any calldata</span>
        SystemContractsCaller<span class="token punctuation">.</span><span class="token function">systemCall</span><span class="token punctuation">(</span>
            <span class="token builtin">uint32</span><span class="token punctuation">(</span><span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            to<span class="token punctuation">,</span>
            <span class="token builtin">uint128</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// By convention, reserved[1] is `value`</span>
            _transaction<span class="token punctuation">.</span>data
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token builtin">bool</span> success<span class="token punctuation">;</span>
        <span class="token keyword">assembly</span> <span class="token punctuation">{</span>
            success <span class="token operator">:=</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token function">gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mload</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>请注意，操作员是否会认为交易成功将仅取决于对 executeTransactions 的调用是否成功。 因此，强烈建议为交易加上<code>require(success)</code>，让用户得到最好的UX。</p> <h3 id="账户的完整代码"><a href="#账户的完整代码" class="header-anchor">#</a> 账户的完整代码</h3> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token comment">// SPDX-License-Identifier: MIT</span>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">&quot;@matterlabs/zksync-contracts/l2/system-contracts/interfaces/IAccount.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;@matterlabs/zksync-contracts/l2/system-contracts/TransactionHelper.sol&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">&quot;@openzeppelin/contracts/interfaces/IERC1271.sol&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Used for signature validation</span>
<span class="token keyword">import</span> <span class="token string">&quot;@openzeppelin/contracts/utils/cryptography/ECDSA.sol&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Access zkSync system contracts, in this case for nonce validation vs NONCE_HOLDER_SYSTEM_CONTRACT</span>
<span class="token keyword">import</span> <span class="token string">&quot;@matterlabs/zksync-contracts/l2/system-contracts/Constants.sol&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// to call non-view method of system contracts</span>
<span class="token keyword">import</span> <span class="token string">&quot;@matterlabs/zksync-contracts/l2/system-contracts/SystemContractsCaller.sol&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">TwoUserMultisig</span> <span class="token keyword">is</span> IAccount<span class="token punctuation">,</span> IERC1271 <span class="token punctuation">{</span>
    <span class="token comment">// to get transaction hash</span>
    <span class="token keyword">using</span> <span class="token class-name">TransactionHelper</span> <span class="token keyword">for</span> Transaction<span class="token punctuation">;</span>

    <span class="token comment">// state variables for account owners</span>
    <span class="token builtin">address</span> <span class="token keyword">public</span> owner1<span class="token punctuation">;</span>
    <span class="token builtin">address</span> <span class="token keyword">public</span> owner2<span class="token punctuation">;</span>

    <span class="token builtin">bytes4</span> <span class="token keyword">constant</span> EIP1271_SUCCESS_RETURN_VALUE <span class="token operator">=</span> <span class="token number">0x1626ba7e</span><span class="token punctuation">;</span>

    <span class="token keyword">modifier</span> <span class="token function">onlyBootloader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>
            msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> BOOTLOADER_FORMAL_ADDRESS<span class="token punctuation">,</span>
            <span class="token string">&quot;Only bootloader can call this method&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Continure execution if called from the bootloader.</span>
        <span class="token keyword">_</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _owner1<span class="token punctuation">,</span> <span class="token builtin">address</span> _owner2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        owner1 <span class="token operator">=</span> _owner1<span class="token punctuation">;</span>
        owner2 <span class="token operator">=</span> _owner2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">validateTransaction</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        <span class="token builtin">bytes32</span> _suggestedSignedHash<span class="token punctuation">,</span>
        Transaction <span class="token keyword">calldata</span> _transaction
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        <span class="token function">_validateTransaction</span><span class="token punctuation">(</span>_suggestedSignedHash<span class="token punctuation">,</span> _transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">_validateTransaction</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span> _suggestedSignedHash<span class="token punctuation">,</span>
        Transaction <span class="token keyword">calldata</span> _transaction
    <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
        <span class="token comment">// Incrementing the nonce of the account.</span>
        <span class="token comment">// Note, that reserved[0] by convention is currently equal to the nonce passed in the transaction</span>
        SystemContractsCaller<span class="token punctuation">.</span><span class="token function">systemCall</span><span class="token punctuation">(</span>
            <span class="token builtin">uint32</span><span class="token punctuation">(</span><span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">address</span><span class="token punctuation">(</span>NONCE_HOLDER_SYSTEM_CONTRACT<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span>
                INonceHolder<span class="token punctuation">.</span>incrementMinNonceIfEquals<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token builtin">bytes32</span> txHash<span class="token punctuation">;</span>
        <span class="token comment">// While the suggested signed hash is usually provided, it is generally</span>
        <span class="token comment">// not recommended to rely on it to be present, since in the future</span>
        <span class="token comment">// there may be tx types with no suggested signed hash.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_suggestedSignedHash <span class="token operator">==</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            txHash <span class="token operator">=</span> _transaction<span class="token punctuation">.</span><span class="token function">encodeHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            txHash <span class="token operator">=</span> _suggestedSignedHash<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">require</span><span class="token punctuation">(</span>
            <span class="token function">isValidSignature</span><span class="token punctuation">(</span>txHash<span class="token punctuation">,</span> _transaction<span class="token punctuation">.</span>signature<span class="token punctuation">)</span> <span class="token operator">==</span>
                EIP1271_SUCCESS_RETURN_VALUE
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">executeTransaction</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        Transaction <span class="token keyword">calldata</span> _transaction
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
        <span class="token builtin">address</span> to <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token builtin">uint160</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> value <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token builtin">bytes</span> <span class="token keyword">memory</span> data <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span>DEPLOYER_SYSTEM_CONTRACT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// We allow calling ContractDeployer with any calldata</span>
            SystemContractsCaller<span class="token punctuation">.</span><span class="token function">systemCall</span><span class="token punctuation">(</span>
                <span class="token builtin">uint32</span><span class="token punctuation">(</span><span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                to<span class="token punctuation">,</span>
                <span class="token builtin">uint128</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// By convention, reserved[1] is `value`</span>
                _transaction<span class="token punctuation">.</span>data
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token builtin">bool</span> success<span class="token punctuation">;</span>
            <span class="token keyword">assembly</span> <span class="token punctuation">{</span>
                success <span class="token operator">:=</span> <span class="token function">call</span><span class="token punctuation">(</span>
                    <span class="token function">gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    to<span class="token punctuation">,</span>
                    value<span class="token punctuation">,</span>
                    <span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">mload</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token number">0</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">executeTransactionFromOutside</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span>
        <span class="token keyword">external</span>
        <span class="token keyword">payable</span>
    <span class="token punctuation">{</span>
        <span class="token function">_validateTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">isValidSignature</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _hash<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> _signature<span class="token punctuation">)</span>
        <span class="token keyword">public</span>
        <span class="token keyword">view</span>
        override
        <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes4</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// The signature is the concatenation of the ECDSA signatures of the owners</span>
        <span class="token comment">// Each ECDSA signature is 65 bytes long. That means that the combined signature is 130 bytes long.</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>_signature<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">130</span><span class="token punctuation">,</span> <span class="token string">&quot;Signature length is incorrect&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token builtin">address</span> recoveredAddr1 <span class="token operator">=</span> ECDSA<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>_hash<span class="token punctuation">,</span> _signature<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">address</span> recoveredAddr2 <span class="token operator">=</span> ECDSA<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>_hash<span class="token punctuation">,</span> _signature<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">:</span><span class="token number">130</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">require</span><span class="token punctuation">(</span>recoveredAddr1 <span class="token operator">==</span> owner1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>recoveredAddr2 <span class="token operator">==</span> owner2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> EIP1271_SUCCESS_RETURN_VALUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">payForTransaction</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        Transaction <span class="token keyword">calldata</span> _transaction
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        <span class="token builtin">bool</span> success <span class="token operator">=</span> _transaction<span class="token punctuation">.</span><span class="token function">payToTheBootloader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">&quot;Failed to pay the fee to the operator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">prePaymaster</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        Transaction <span class="token keyword">calldata</span> _transaction
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        _transaction<span class="token punctuation">.</span><span class="token function">processPaymasterInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span>
        <span class="token comment">// If the bootloader called the `receive` function, it likely means</span>
        <span class="token comment">// that something went wrong and the transaction should be aborted. The bootloader should</span>
        <span class="token comment">// only interact through the `validateTransaction`/`executeTransaction` methods.</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">!=</span> BOOTLOADER_FORMAL_ADDRESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="代理"><a href="#代理" class="header-anchor">#</a> 代理</h2> <p>现在，让我们构建一个可以部署的账户代理。 请注意，如果我们要部署 AA，我们需要直接与<code>DEPLOYER_SYSTEM_CONTRACT</code>进行交互。 对于确定性地址，我们将使用 create2Account 方法。</p> <p>代码将如下所示：</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token comment">// SPDX-License-Identifier: MIT</span>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">'@matterlabs/zksync-contracts/l2/system-contracts/Constants.sol'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'@matterlabs/zksync-contracts/l2/system-contracts/SystemContractsCaller.sol'</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">AAFactory</span> <span class="token punctuation">{</span>
    <span class="token builtin">bytes32</span> <span class="token keyword">public</span> aaBytecodeHash<span class="token punctuation">;</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _aaBytecodeHash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        aaBytecodeHash <span class="token operator">=</span> _aaBytecodeHash<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">deployAccount</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span> salt<span class="token punctuation">,</span>
        <span class="token builtin">address</span> owner1<span class="token punctuation">,</span>
        <span class="token builtin">address</span> owner2
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">address</span> accountAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">bytes</span> <span class="token keyword">memory</span> returnData <span class="token operator">=</span> SystemContractsCaller<span class="token punctuation">.</span><span class="token function">systemCall</span><span class="token punctuation">(</span>
            <span class="token builtin">uint32</span><span class="token punctuation">(</span><span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">address</span><span class="token punctuation">(</span>DEPLOYER_SYSTEM_CONTRACT<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span>
                DEPLOYER_SYSTEM_CONTRACT<span class="token punctuation">.</span>create2Account<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>salt<span class="token punctuation">,</span> aaBytecodeHash<span class="token punctuation">,</span> abi<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>owner1<span class="token punctuation">,</span> owner2<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">(</span>accountAddress<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>returnData<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>请注意，在 zkSync 上，部署不是通过字节码完成的，而是通过字节码哈希完成的。 字节码本身通过<code>factoryDeps</code>字段传递给操作员。 请注意，<code>_aaBytecodeHash</code> 必须专门形成：</p> <ul><li>首先，它用 sha256 散列。</li> <li>然后，前两个字节被字节码的长度替换为 32 字节字。</li></ul> <p>您无需担心，因为我们的 SDK 提供了一个内置方法来执行此操作，如下所述。</p> <h2 id="部署代理"><a href="#部署代理" class="header-anchor">#</a> 部署代理</h2> <p>首先，我们需要创建一个部署脚本。 创建 在<code>deploy</code> 文件夹在创建一个文件：<code>deploy-factory.ts</code>。 将以下部署脚本放在那里：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> utils<span class="token punctuation">,</span> Wallet <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;zksync-web3&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> ethers <span class="token keyword">from</span> <span class="token string">&quot;ethers&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HardhatRuntimeEnvironment <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;hardhat/types&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Deployer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@matterlabs/hardhat-zksync-deploy&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>hre<span class="token operator">:</span> HardhatRuntimeEnvironment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> wallet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wallet</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;PRIVATE-KEY&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> deployer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Deployer</span><span class="token punctuation">(</span>hre<span class="token punctuation">,</span> wallet<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> factoryArtifact <span class="token operator">=</span> <span class="token keyword">await</span> deployer<span class="token punctuation">.</span><span class="token function">loadArtifact</span><span class="token punctuation">(</span><span class="token string">&quot;AAFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> aaArtifact <span class="token operator">=</span> <span class="token keyword">await</span> deployer<span class="token punctuation">.</span><span class="token function">loadArtifact</span><span class="token punctuation">(</span><span class="token string">&quot;TwoUserMultisig&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Deposit some funds to L2 in order to be able to perform L2 transactions.</span>
  <span class="token comment">// You can remove the depositing step if the `wallet` has enough funds on zkSync</span>
  <span class="token keyword">const</span> depositAmount <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">&quot;0.001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> depositHandle <span class="token operator">=</span> <span class="token keyword">await</span> deployer<span class="token punctuation">.</span>zkWallet<span class="token punctuation">.</span><span class="token function">deposit</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    to<span class="token operator">:</span> deployer<span class="token punctuation">.</span>zkWallet<span class="token punctuation">.</span>address<span class="token punctuation">,</span>
    token<span class="token operator">:</span> utils<span class="token punctuation">.</span><span class="token constant">ETH_ADDRESS</span><span class="token punctuation">,</span>
    amount<span class="token operator">:</span> depositAmount<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> depositHandle<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Getting the bytecodeHash of the account</span>
  <span class="token keyword">const</span> bytecodeHash <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">hashBytecode</span><span class="token punctuation">(</span>aaArtifact<span class="token punctuation">.</span>bytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> factory <span class="token operator">=</span> <span class="token keyword">await</span> deployer<span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span>factoryArtifact<span class="token punctuation">,</span> <span class="token punctuation">[</span>bytecodeHash<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token comment">// Since the factory requires the code of the multisig to be available,</span>
    <span class="token comment">// we should pass it here as well.</span>
    aaArtifact<span class="token punctuation">.</span>bytecode<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">AA factory address: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>factory<span class="token punctuation">.</span>address<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>为了部署工厂，您应该编译合约并运行脚本：</p> <div class="language- extra-class"><pre class="language-text"><code>yarn hardhat compile
yarn hardhat deploy-zksync --script deploy-factory.ts
</code></pre></div><p>输出如下：</p> <div class="language- extra-class"><pre class="language-text"><code>AA factory address: 0x9db333Cb68Fb6D317E3E415269a5b9bE7c72627Ds
</code></pre></div><p>请注意，每次运行的地址都会不同。</p> <h2 id="使用账户"><a href="#使用账户" class="header-anchor">#</a> 使用账户</h2> <h3 id="部署账户"><a href="#部署账户" class="header-anchor">#</a> 部署账户</h3> <p>现在，让我们部署一个账户并使用它启动一个新交易。 在本节中，我们假设您已经在 zkSync 上拥有一个足够资金的 EOA 账户。
在 <code>deploy</code> 文件夹中创建一个文件 <code>deploy-multisig.ts</code>，我们将在其中放置脚本。</p> <p>首先，让我们部署 AA。 这将是对 <code>deployAccount</code> 函数的调用：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> utils<span class="token punctuation">,</span> Wallet<span class="token punctuation">,</span> Provider<span class="token punctuation">,</span> EIP712Signer<span class="token punctuation">,</span> types <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;zksync-web3&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> ethers <span class="token keyword">from</span> <span class="token string">&quot;ethers&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HardhatRuntimeEnvironment <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;hardhat/types&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Put the address of your AA factory</span>
<span class="token keyword">const</span> <span class="token constant">AA_FACTORY_ADDRESS</span> <span class="token operator">=</span> <span class="token string">&quot;&lt;YOUR_FACTORY_ADDRESS&gt;&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// An example of a deploy script deploys and calls a simple contract.</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>hre<span class="token operator">:</span> HardhatRuntimeEnvironment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Provider</span><span class="token punctuation">(</span>hre<span class="token punctuation">.</span>config<span class="token punctuation">.</span>zkSyncDeploy<span class="token punctuation">.</span>zkSyncNetwork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> wallet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wallet</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;PRIVATE-KEY&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> factoryArtifact <span class="token operator">=</span> <span class="token keyword">await</span> hre<span class="token punctuation">.</span>artifacts<span class="token punctuation">.</span><span class="token function">readArtifact</span><span class="token punctuation">(</span><span class="token string">&quot;AAFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> aaFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers</span><span class="token punctuation">.</span><span class="token function">Contract</span><span class="token punctuation">(</span><span class="token constant">AA_FACTORY_ADDRESS</span><span class="token punctuation">,</span> factoryArtifact<span class="token punctuation">.</span>abi<span class="token punctuation">,</span> wallet<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The two owners of the multisig</span>
  <span class="token keyword">const</span> owner1 <span class="token operator">=</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> owner2 <span class="token operator">=</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// For the simplicity of the tutorial, we will use zero hash as salt</span>
  <span class="token keyword">const</span> salt <span class="token operator">=</span> ethers<span class="token punctuation">.</span>constants<span class="token punctuation">.</span>HashZero<span class="token punctuation">;</span>

  <span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span><span class="token function">deployAccount</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> owner1<span class="token punctuation">.</span>address<span class="token punctuation">,</span> owner2<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> tx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Getting the address of the deployed contract</span>
  <span class="token keyword">const</span> abiCoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">AbiCoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> multisigAddress <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">create2Address</span><span class="token punctuation">(</span>
    <span class="token constant">AA_FACTORY_ADDRESS</span><span class="token punctuation">,</span>
    <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span><span class="token function">aaBytecodeHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    salt<span class="token punctuation">,</span>
    abiCoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;address&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>owner1<span class="token punctuation">.</span>address<span class="token punctuation">,</span> owner2<span class="token punctuation">.</span>address<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Deployed on address </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>multisigAddress<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><em>注意，zkSync 与 Ethereum</em> 有不同的地址规则。 您应该始终使用 <code>zksync-web3</code> SDK 的 <code>createAddress</code> 和 <code>create2Address</code> 的实用方法。</p> <h3 id="从此账户开始交易"><a href="#从此账户开始交易" class="header-anchor">#</a> 从此账户开始交易</h3> <p>在部署的账户可以进行交易之前，我们需要对其进行充值：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">await</span><span class="token punctuation">(</span>
  <span class="token keyword">await</span> wallet<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    to<span class="token operator">:</span> multisigAddress<span class="token punctuation">,</span>
    <span class="token comment">// You can increase the amount of ETH sent to the multisig</span>
    value<span class="token operator">:</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">&quot;0.003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>现在，作为示例，让我们尝试部署一个新的多重签名，但交易的发起者将是我们在上一部分中部署的帐户：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">let</span> aaTx <span class="token operator">=</span> <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span>populateTransaction<span class="token punctuation">.</span><span class="token function">deployAccount</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address<span class="token punctuation">,</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后，我们需要填写所有交易字段：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> gasLimit <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">estimateGas</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> gasPrice <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getGasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

aaTx <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>aaTx<span class="token punctuation">,</span>
  from<span class="token operator">:</span> multisigAddress<span class="token punctuation">,</span>
  gasLimit<span class="token operator">:</span> gasLimit<span class="token punctuation">,</span>
  gasPrice<span class="token operator">:</span> gasPrice<span class="token punctuation">,</span>
  chainId<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getNetwork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>chainId<span class="token punctuation">,</span>
  nonce<span class="token operator">:</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token number">113</span><span class="token punctuation">,</span>
  customData<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// Note, that we are using the `DEFAULT_ERGS_PER_PUBDATA_LIMIT`</span>
    ergsPerPubdata<span class="token operator">:</span> utils<span class="token punctuation">.</span><span class="token constant">DEFAULT_ERGS_PER_PUBDATA_LIMIT</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> types<span class="token punctuation">.</span>Eip712Meta<span class="token punctuation">,</span>
  value<span class="token operator">:</span> ethers<span class="token punctuation">.</span>BigNumber<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>::: 关于 gasLimit 的注意事项</p> <p>目前，我们希望 <code>gasLimit</code> 涵盖验证和执行步骤。 目前，<code>estimateGas</code> 返回的 erg 数量是 <code>execution_ergs + 20000</code>，其中 <code>20000</code> 大致等于 defaultAA 收取费用和验证签名所需的开销。 如果你的 AA 有一个非常昂贵的验证步骤，你应该在 <code>gasLimit</code> 中添加一些常量。</p> <p>:::</p> <p>然后，我们需要对交易进行签名，并在交易的 customData 中提供 <code>aaParamas</code>：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> signedTxHash <span class="token operator">=</span> EIP712Signer<span class="token punctuation">.</span><span class="token function">getSignedDigest</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> signature <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token comment">// Note, that `signMessage` wouldn't work here, since we don't want</span>
  <span class="token comment">// the signed hash to be prefixed with `\x19Ethereum Signed Message:\n`</span>
  ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">joinSignature</span><span class="token punctuation">(</span>owner1<span class="token punctuation">.</span><span class="token function">_signingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signDigest</span><span class="token punctuation">(</span>signedTxHash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">joinSignature</span><span class="token punctuation">(</span>owner2<span class="token punctuation">.</span><span class="token function">_signingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signDigest</span><span class="token punctuation">(</span>signedTxHash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

aaTx<span class="token punctuation">.</span>customData <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>aaTx<span class="token punctuation">.</span>customData<span class="token punctuation">,</span>
  customSignature<span class="token operator">:</span> signature<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>现在，我们准备发送交易：</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The multisig's nonce before the first tx is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sentTx <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span>utils<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> sentTx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Checking that the nonce for the account has increased</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The multisig's nonce after the first tx is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="完整示例"><a href="#完整示例" class="header-anchor">#</a> 完整示例</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> utils<span class="token punctuation">,</span> Wallet<span class="token punctuation">,</span> Provider<span class="token punctuation">,</span> EIP712Signer<span class="token punctuation">,</span> types <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;zksync-web3&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> ethers <span class="token keyword">from</span> <span class="token string">&quot;ethers&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HardhatRuntimeEnvironment <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;hardhat/types&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Put the address of your AA factory</span>
<span class="token keyword">const</span> <span class="token constant">AA_FACTORY_ADDRESS</span> <span class="token operator">=</span> <span class="token string">&quot;&lt;YOUR_FACTORY_ADDRESS&gt;&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>hre<span class="token operator">:</span> HardhatRuntimeEnvironment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Provider</span><span class="token punctuation">(</span>hre<span class="token punctuation">.</span>config<span class="token punctuation">.</span>zkSyncDeploy<span class="token punctuation">.</span>zkSyncNetwork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> wallet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wallet</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;YOUR_PRIVATE_KEY&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> factoryArtifact <span class="token operator">=</span> <span class="token keyword">await</span> hre<span class="token punctuation">.</span>artifacts<span class="token punctuation">.</span><span class="token function">readArtifact</span><span class="token punctuation">(</span><span class="token string">&quot;AAFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> aaFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers</span><span class="token punctuation">.</span><span class="token function">Contract</span><span class="token punctuation">(</span><span class="token constant">AA_FACTORY_ADDRESS</span><span class="token punctuation">,</span> factoryArtifact<span class="token punctuation">.</span>abi<span class="token punctuation">,</span> wallet<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The two owners of the multisig</span>
  <span class="token keyword">const</span> owner1 <span class="token operator">=</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> owner2 <span class="token operator">=</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// For the simplicity of the tutorial, we will use zero hash as salt</span>
  <span class="token keyword">const</span> salt <span class="token operator">=</span> ethers<span class="token punctuation">.</span>constants<span class="token punctuation">.</span>HashZero<span class="token punctuation">;</span>

  <span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span><span class="token function">deployAccount</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> owner1<span class="token punctuation">.</span>address<span class="token punctuation">,</span> owner2<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> tx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Getting the address of the deployed contract</span>
  <span class="token keyword">const</span> abiCoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">AbiCoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> multisigAddress <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">create2Address</span><span class="token punctuation">(</span>
    <span class="token constant">AA_FACTORY_ADDRESS</span><span class="token punctuation">,</span>
    <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span><span class="token function">aaBytecodeHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    salt<span class="token punctuation">,</span>
    abiCoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;address&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>owner1<span class="token punctuation">.</span>address<span class="token punctuation">,</span> owner2<span class="token punctuation">.</span>address<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Multisig deployed on address </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>multisigAddress<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> <span class="token punctuation">(</span>
    <span class="token keyword">await</span> wallet<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      to<span class="token operator">:</span> multisigAddress<span class="token punctuation">,</span>
      <span class="token comment">// You can increase the amount of ETH sent to the multisig</span>
      value<span class="token operator">:</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">&quot;0.001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> aaTx <span class="token operator">=</span> <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span>populateTransaction<span class="token punctuation">.</span><span class="token function">deployAccount</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address<span class="token punctuation">,</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> gasLimit <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">estimateGas</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> gasPrice <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getGasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  aaTx <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>aaTx<span class="token punctuation">,</span>
    from<span class="token operator">:</span> multisigAddress<span class="token punctuation">,</span>
    gasLimit<span class="token operator">:</span> gasLimit<span class="token punctuation">,</span>
    gasPrice<span class="token operator">:</span> gasPrice<span class="token punctuation">,</span>
    chainId<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getNetwork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>chainId<span class="token punctuation">,</span>
    nonce<span class="token operator">:</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token number">113</span><span class="token punctuation">,</span>
    customData<span class="token operator">:</span> <span class="token punctuation">{</span>
      ergsPerPubdata<span class="token operator">:</span> utils<span class="token punctuation">.</span><span class="token constant">DEFAULT_ERGS_PER_PUBDATA_LIMIT</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token keyword">as</span> types<span class="token punctuation">.</span>Eip712Meta<span class="token punctuation">,</span>
    value<span class="token operator">:</span> ethers<span class="token punctuation">.</span>BigNumber<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> signedTxHash <span class="token operator">=</span> EIP712Signer<span class="token punctuation">.</span><span class="token function">getSignedDigest</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> signature <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token comment">// Note, that `signMessage` wouldn't work here, since we don't want</span>
    <span class="token comment">// the signed hash to be prefixed with `\x19Ethereum Signed Message:\n`</span>
    ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">joinSignature</span><span class="token punctuation">(</span>owner1<span class="token punctuation">.</span><span class="token function">_signingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signDigest</span><span class="token punctuation">(</span>signedTxHash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">joinSignature</span><span class="token punctuation">(</span>owner2<span class="token punctuation">.</span><span class="token function">_signingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signDigest</span><span class="token punctuation">(</span>signedTxHash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  aaTx<span class="token punctuation">.</span>customData <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>aaTx<span class="token punctuation">.</span>customData<span class="token punctuation">,</span>
    customSignature<span class="token operator">:</span> signature<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The multisig's nonce before the first tx is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sentTx <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span>utils<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> sentTx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Checking that the nonce for the account has increased</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The multisig's nonce after the first tx is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>要运行脚本，请使用以下命令：</p> <div class="language- extra-class"><pre class="language-text"><code>yarn hardhat deploy-zksync --script deploy-multisig.ts
</code></pre></div><p>输出应该大致如下：</p> <div class="language- extra-class"><pre class="language-text"><code>Multisig deployed on address 0xCEBc59558938bccb43A6C94769F87bBdb770E956
The multisig's nonce before the first tx is 0
The multisig's nonce after the first tx is 1
</code></pre></div><p>::: 提示</p> <p>如果您收到错误提示<code>Not enough balance to cover the fee。</code>，请尝试增加发送到多重签名钱包的 ETH 数量，以便它有足够的资金来支付交易费用。</p> <p>:::</p> <h2 id="完成项目"><a href="#完成项目" class="header-anchor">#</a> 完成项目</h2> <p>您可以在 <a href="https://github.com/matter-labs/custom-aa-tutorial" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 下载完整的项目。</p> <h2 id="learn-more"><a href="#learn-more" class="header-anchor">#</a> Learn more</h2> <ul><li>要了解有关 zkSync 上的 L1-&gt;L2 交互的更多信息，请查看 <a href="/dev/developer-guides/bridging/l1-l2.html">文档</a>。</li> <li>要了解有关 <code>zksync-web3</code> SDK 的更多信息，请查看 [文档。</li> <li>要了解有关 zkSync 安全帽插件的更多信息，请查看他们的 <a href="../../api/hardhat">文档</a>。</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/matter-labs/zksync-web-v2-docs/edit/main/docs/dev/tutorials/custom-aa-tutorial.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/26/2022, 9:20:40 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/dev/tutorials/cross-chain-tutorial.html" class="prev">
        跨链治理
      </a></span> <span class="next"><a href="/dev/tutorials/custom-paymaster-tutorial.html">
        建立自定义 paymaster
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c05cfcc8.js" defer></script><script src="/assets/js/2.5a73362d.js" defer></script><script src="/assets/js/73.c6b3bb28.js" defer></script>
  </body>
</html>
