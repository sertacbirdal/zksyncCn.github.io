<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Account abstraction | zkSync — Accelerating the mass adoption of crypto for personal sovereignty</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script src="/__/firebase/7.13.2/firebase-app.js" defer="true"></script>
    <script src="/__/firebase/7.13.2/firebase-analytics.js" defer="true"></script>
    <script src="/__/firebase/init.js" defer="true"></script>
    <script>
  const logoUrlChanger = setInterval(function() {
    //Anchor above the logo image
    const homeEls = document.getElementsByClassName("home-link");
    if(homeEls.length > 0) {
      const homeEl = homeEls[0];
      homeEl.setAttribute("href", "https://zksync.io");
      homeEl.setAttribute("onclick", "document.location='https://zksync.io';return false;");
      clearInterval(logoUrlChanger);
    }

    //Actual logo image
    const logoEls = document.getElementsByClassName("logo")
    if(logoEls.length > 0) {
      const logoEl = logoEls[0]
      logoEl.setAttribute("onclick", "document.location='https://zksync.io';return false;");
      clearInterval(logoUrlChanger);
    }
  }, 1000)</script>
    <meta name="description" content="zkSync is a ZK rollup that represents the end-game for scaling Ethereum - one that scales its technology and values without degrading security or decentralization">
    
    <link rel="preload" href="/assets/css/0.styles.350a0b01.css" as="style"><link rel="preload" href="/assets/js/app.7b8ca578.js" as="script"><link rel="preload" href="/assets/js/2.5a73362d.js" as="script"><link rel="preload" href="/assets/js/73.0d4f65f9.js" as="script"><link rel="prefetch" href="/assets/js/10.1d31b665.js"><link rel="prefetch" href="/assets/js/11.f493f97a.js"><link rel="prefetch" href="/assets/js/12.0a46d712.js"><link rel="prefetch" href="/assets/js/13.e7352fdc.js"><link rel="prefetch" href="/assets/js/14.0c7cfd9a.js"><link rel="prefetch" href="/assets/js/15.94b050a9.js"><link rel="prefetch" href="/assets/js/16.b8c52aa4.js"><link rel="prefetch" href="/assets/js/17.7e3694b3.js"><link rel="prefetch" href="/assets/js/18.523d436b.js"><link rel="prefetch" href="/assets/js/19.248e6c74.js"><link rel="prefetch" href="/assets/js/20.abf592a4.js"><link rel="prefetch" href="/assets/js/21.51ea3602.js"><link rel="prefetch" href="/assets/js/22.d2979550.js"><link rel="prefetch" href="/assets/js/23.402a0d23.js"><link rel="prefetch" href="/assets/js/24.6bacca56.js"><link rel="prefetch" href="/assets/js/25.afe0dc2b.js"><link rel="prefetch" href="/assets/js/26.1d5572a0.js"><link rel="prefetch" href="/assets/js/27.a115d37b.js"><link rel="prefetch" href="/assets/js/28.8dee3885.js"><link rel="prefetch" href="/assets/js/29.1a1c57dd.js"><link rel="prefetch" href="/assets/js/3.d90af0c5.js"><link rel="prefetch" href="/assets/js/30.9cd7b1a3.js"><link rel="prefetch" href="/assets/js/31.51c62990.js"><link rel="prefetch" href="/assets/js/32.665572a2.js"><link rel="prefetch" href="/assets/js/33.018706b6.js"><link rel="prefetch" href="/assets/js/34.55102de6.js"><link rel="prefetch" href="/assets/js/35.2f4d0897.js"><link rel="prefetch" href="/assets/js/36.d86e7687.js"><link rel="prefetch" href="/assets/js/37.6310a1d0.js"><link rel="prefetch" href="/assets/js/38.52314fd5.js"><link rel="prefetch" href="/assets/js/39.9ac412c7.js"><link rel="prefetch" href="/assets/js/4.f44bd373.js"><link rel="prefetch" href="/assets/js/40.303d81a3.js"><link rel="prefetch" href="/assets/js/41.6e2303a5.js"><link rel="prefetch" href="/assets/js/42.9d963b05.js"><link rel="prefetch" href="/assets/js/43.a93166b9.js"><link rel="prefetch" href="/assets/js/44.6e1a6fcc.js"><link rel="prefetch" href="/assets/js/45.4fbbea7f.js"><link rel="prefetch" href="/assets/js/46.9ce3f58c.js"><link rel="prefetch" href="/assets/js/47.d6b951c1.js"><link rel="prefetch" href="/assets/js/48.5a3734c4.js"><link rel="prefetch" href="/assets/js/49.2a6881e2.js"><link rel="prefetch" href="/assets/js/5.3964cc5a.js"><link rel="prefetch" href="/assets/js/50.7dcd49ad.js"><link rel="prefetch" href="/assets/js/51.6d547b98.js"><link rel="prefetch" href="/assets/js/52.afdd09d2.js"><link rel="prefetch" href="/assets/js/53.70102f1d.js"><link rel="prefetch" href="/assets/js/54.2e3038e3.js"><link rel="prefetch" href="/assets/js/55.b162aa77.js"><link rel="prefetch" href="/assets/js/56.fe219180.js"><link rel="prefetch" href="/assets/js/57.fc29b145.js"><link rel="prefetch" href="/assets/js/58.c89685dc.js"><link rel="prefetch" href="/assets/js/59.04d5061e.js"><link rel="prefetch" href="/assets/js/6.fd04f34e.js"><link rel="prefetch" href="/assets/js/60.393042fa.js"><link rel="prefetch" href="/assets/js/61.df0f09f2.js"><link rel="prefetch" href="/assets/js/62.1a9541a9.js"><link rel="prefetch" href="/assets/js/63.ea0501a4.js"><link rel="prefetch" href="/assets/js/64.ebd6db8c.js"><link rel="prefetch" href="/assets/js/65.ea970aff.js"><link rel="prefetch" href="/assets/js/66.ac257db5.js"><link rel="prefetch" href="/assets/js/67.3c815a55.js"><link rel="prefetch" href="/assets/js/68.c6fed9d6.js"><link rel="prefetch" href="/assets/js/69.937986ed.js"><link rel="prefetch" href="/assets/js/7.9cb55bb9.js"><link rel="prefetch" href="/assets/js/70.25b1f05d.js"><link rel="prefetch" href="/assets/js/71.6812e6cd.js"><link rel="prefetch" href="/assets/js/72.be287cf6.js"><link rel="prefetch" href="/assets/js/74.1d200155.js"><link rel="prefetch" href="/assets/js/75.eaafcd32.js"><link rel="prefetch" href="/assets/js/76.1dd3556b.js"><link rel="prefetch" href="/assets/js/8.f9eaafb5.js"><link rel="prefetch" href="/assets/js/9.2e9fb4a6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.350a0b01.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/LogotypeLight.svg" alt="zkSync — Accelerating the mass adoption of crypto for personal sovereignty" class="logo"> <span class="site-name can-hide">zkSync — Accelerating the mass adoption of crypto for personal sovereignty</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/dev/" class="nav-link router-link-active">
  开发文档
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  工具/SDK
</a></div><div class="nav-item"><a href="/contact.html" class="nav-link">
  联系我们
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="v2.0" class="dropdown-title"><span class="title">v2.0</span> <span class="arrow down"></span></button> <button type="button" aria-label="v2.0" class="mobile-dropdown-title"><span class="title">v2.0</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/dev/" class="nav-link router-link-active">
  v2.0
</a></li><li class="dropdown-item"><!----> <a href="https://docs.zksync.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v1.x
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/matter-labs/zksync-web-v2-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/dev/" class="nav-link router-link-active">
  开发文档
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  工具/SDK
</a></div><div class="nav-item"><a href="/contact.html" class="nav-link">
  联系我们
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="v2.0" class="dropdown-title"><span class="title">v2.0</span> <span class="arrow down"></span></button> <button type="button" aria-label="v2.0" class="mobile-dropdown-title"><span class="title">v2.0</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/dev/" class="nav-link router-link-active">
  v2.0
</a></li><li class="dropdown-item"><!----> <a href="https://docs.zksync.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v1.x
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/matter-labs/zksync-web-v2-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/dev/" aria-current="page" class="sidebar-link">介绍</a></li><li><section class="sidebar-group depth-0"><a href="/dev/fundamentals" class="sidebar-heading clickable"><span>开始</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/fundamentals/rollups.html" class="sidebar-link">rollups 介绍</a></li><li><a href="/dev/fundamentals/zkSync.html" class="sidebar-link">zkSync 基础知识</a></li><li><a href="/dev/fundamentals/testnet.html" class="sidebar-link">zkSync 测试网</a></li><li><a href="/dev/fundamentals/faq.html" class="sidebar-link">FAQ</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/dev/developer-guides" class="sidebar-heading clickable"><span>关于zkSync</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/developer-guides/transactions/transactions.html" class="sidebar-link">交易</a></li><li><a href="/dev/developer-guides/transactions/blocks.html" class="sidebar-link">区块</a></li><li><a href="/dev/developer-guides/contracts/system-contracts.html" class="sidebar-link">系统合约</a></li><li><a href="/dev/developer-guides/aa.html" class="sidebar-link">Account abstraction support</a></li><li><a href="/dev/developer-guides/security.html" class="sidebar-link">Security model</a></li><li><a href="/dev/developer-guides/transactions/fee-model.html" class="sidebar-link">Fee mechanism</a></li><li><a href="/dev/developer-guides/bridging/bridging-asset.html" class="sidebar-link">Bridging assets</a></li><li><a href="/dev/developer-guides/bridging/l1-l2-interop.html" class="sidebar-link">L1 / L2 Interoperability</a></li><li><a href="/dev/developer-guides/bridging/l1-l2.html" class="sidebar-link">L1 -&gt; L2 communication</a></li><li><a href="/dev/developer-guides/bridging/l2-l1.html" class="sidebar-link">L2 -&gt; L1 communication</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/dev/developer-guides/building-on-zksync" class="sidebar-heading clickable"><span>在zkSync上构建</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/developer-guides/hello-world.html" class="sidebar-link">Quickstart</a></li><li><a href="/dev/developer-guides/contracts/contracts.html" class="sidebar-link">合约部署</a></li><li><a href="/dev/developer-guides/contracts/contract-verification.html" class="sidebar-link">Verify smart contracts</a></li><li><a href="/dev/developer-guides/building-on-zksync/events.html" class="sidebar-link">Handling events</a></li><li><a href="/dev/developer-guides/building-on-zksync/rpc.html" class="sidebar-link">JSON-RPC API</a></li><li><a href="/dev/developer-guides/building-on-zksync/videos.html" class="sidebar-link">Video resources</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/dev/tutorials" class="sidebar-heading clickable router-link-active open"><span>教程</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/tutorials/cross-chain-tutorial.html" class="sidebar-link">Cross-chain governance</a></li><li><a href="/dev/tutorials/custom-aa-tutorial.html" aria-current="page" class="active sidebar-link">Account abstraction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dev/tutorials/custom-aa-tutorial.html#prerequisite" class="sidebar-link">Prerequisite</a></li><li class="sidebar-sub-header"><a href="/dev/tutorials/custom-aa-tutorial.html#installing-dependencies" class="sidebar-link">Installing dependencies</a></li><li class="sidebar-sub-header"><a href="/dev/tutorials/custom-aa-tutorial.html#account-abstraction-2" class="sidebar-link">Account abstraction</a></li><li class="sidebar-sub-header"><a href="/dev/tutorials/custom-aa-tutorial.html#the-factory" class="sidebar-link">The factory</a></li><li class="sidebar-sub-header"><a href="/dev/tutorials/custom-aa-tutorial.html#deploying-the-factory" class="sidebar-link">Deploying the factory</a></li><li class="sidebar-sub-header"><a href="/dev/tutorials/custom-aa-tutorial.html#working-with-accounts" class="sidebar-link">Working with accounts</a></li><li class="sidebar-sub-header"><a href="/dev/tutorials/custom-aa-tutorial.html#complete-project" class="sidebar-link">Complete project</a></li><li class="sidebar-sub-header"><a href="/dev/tutorials/custom-aa-tutorial.html#learn-more" class="sidebar-link">Learn more</a></li></ul></li><li><a href="/dev/tutorials/custom-paymaster-tutorial.html" class="sidebar-link">Building custom paymaster</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/dev/troubleshooting" class="sidebar-heading clickable"><span>错误排除</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/troubleshooting/important-links.html" class="sidebar-link">Important links</a></li><li><a href="/dev/troubleshooting/status.html" class="sidebar-link">Feature support status</a></li><li><a href="/dev/troubleshooting/docs-contribution/docs.html" class="sidebar-link">文档贡献指南</a></li><li><a href="/dev/troubleshooting/docs-contribution/community-resources.html" class="sidebar-link">Community resources</a></li><li><a href="/dev/troubleshooting/known-issues.html" class="sidebar-link">Known issues</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="account-abstraction"><a href="#account-abstraction" class="header-anchor">#</a> Account abstraction</h1> <p>Now, let's learn how to deploy your custom accounts and interact directly with the <a href="/dev/developer-guides/contracts/system-contracts.html#contractdeployer">ContractDeployer</a> system contract.
In this tutorial, we build a factory that deploys 2-of-2 multisig accounts.</p> <h2 id="prerequisite"><a href="#prerequisite" class="header-anchor">#</a> Prerequisite</h2> <p>It is highly recommended to read about the <a href="/dev/developer-guides/aa.html">design</a> of the account abstraction protocol before diving into this tutorial.</p> <p>It is assumed that you are already familiar with deploying smart contracts on zkSync.
If not, please refer to the first section of the <a href="/dev/developer-guides/hello-world.html">quickstart tutorial</a>.
It is also recommended to read the <a href="/dev/developer-guides/contracts/system-contracts.html">introduction</a> to the system contracts.</p> <h2 id="installing-dependencies"><a href="#installing-dependencies" class="header-anchor">#</a> Installing dependencies</h2> <p>We will use the zkSync hardhat plugin for developing this contract. Firstly, we should install all the dependencies for it:</p> <div class="language- extra-class"><pre class="language-text"><code>mkdir custom-aa-tutorial
cd custom-aa-tutorial
yarn init -y
yarn add -D typescript ts-node ethers zksync-web3 hardhat @matterlabs/hardhat-zksync-solc @matterlabs/hardhat-zksync-deploy
</code></pre></div><p>Since we are working with zkSync contracts, we also need to install the package with the contracts and its peer dependencies:</p> <div class="language- extra-class"><pre class="language-text"><code>yarn add @matterlabs/zksync-contracts @openzeppelin/contracts @openzeppelin/contracts-upgradeable
</code></pre></div><p>Also, create the <code>hardhat.config.ts</code> config file, <code>contracts</code> and <code>deploy</code> folders, like in the <a href="/dev/developer-guides/hello-world.html">quickstart tutorial</a>.</p> <h2 id="account-abstraction-2"><a href="#account-abstraction-2" class="header-anchor">#</a> Account abstraction</h2> <p>Each account needs to implement the <a href="/dev/developer-guides/aa.html#iaccount-interface">IAccount</a> interface. Since we are building an account with signers, we should also have <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/83277ff916ac4f58fec072b8f28a252c1245c2f1/contracts/interfaces/IERC1271.sol#L12" target="_blank" rel="noopener noreferrer">EIP1271<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> implemented.</p> <p>The skeleton for the contract will look the following way:</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token comment">// SPDX-License-Identifier: MIT</span>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">'@matterlabs/zksync-contracts/l2/system-contracts/interfaces/IAccount.sol'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'@matterlabs/zksync-contracts/l2/system-contracts/TransactionHelper.sol'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">&quot;@openzeppelin/contracts/interfaces/IERC1271.sol&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">TwoUserMultisig</span> <span class="token keyword">is</span> IAccount<span class="token punctuation">,</span> IERC1271 <span class="token punctuation">{</span>

    <span class="token keyword">modifier</span> <span class="token function">onlyBootloader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> BOOTLOADER_FORMAL_ADDRESS<span class="token punctuation">,</span> <span class="token string">&quot;Only bootloader can call this method&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Continure execution if called from the bootloader.</span>
        <span class="token keyword">_</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">validateTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span> _suggestedSignedHash<span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        <span class="token function">_validateTransaction</span><span class="token punctuation">(</span>_suggestedSignedHash<span class="token punctuation">,</span> _transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">_validateTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _suggestedSignedHash<span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">executeTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">executeTransactionFromOutside</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span>
        <span class="token function">_validateTransaction</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

      <span class="token builtin">bytes4</span> <span class="token keyword">constant</span> EIP1271_SUCCESS_RETURN_VALUE <span class="token operator">=</span> <span class="token number">0x1626ba7e</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">isValidSignature</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _hash<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> _signature<span class="token punctuation">)</span> <span class="token keyword">public</span> override <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> EIP1271_SUCCESS_RETURN_VALUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">payForTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">prePaymaster</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

      <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span>
        <span class="token comment">// If the bootloader called the `receive` function, it likely means</span>
        <span class="token comment">// that something went wrong and the transaction should be aborted. The bootloader should</span>
        <span class="token comment">// only interact through the `validateTransaction`/`executeTransaction` methods.</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">!=</span> BOOTLOADER_FORMAL_ADDRESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Note, that only the <a href="/dev/developer-guides/contracts/system-contracts.html#bootloader">bootloader</a> should be allowed to call the <code>validateTransaction</code>/<code>executeTransaction</code>/<code>payForTransaction</code>/<code>prePaymaster</code> methods.
That's why the <code>onlyBootloader</code> modifier is used for them.</p> <p>The <code>executeTransactionFromOutside</code> is needed to allow external users to initiate transactions from this account. The easiest way to implement it is to do the same as <code>validateTransaction</code> + <code>executeTransaction</code> would do.</p> <h3 id="signature-validation"><a href="#signature-validation" class="header-anchor">#</a> Signature validation</h3> <p>Firstly, we need to implement the signature validation process. Since we are building a two-account multisig, let's pass its owners' addresses in the constructor. In this tutorial, we use OpenZeppelin's <code>ECDSA</code> library for signature validation.</p> <p>Add the following import:</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">import</span> <span class="token string">&quot;@openzeppelin/contracts/utils/cryptography/ECDSA.sol&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>Also, add the constructor to the contract:</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token builtin">address</span> <span class="token keyword">public</span> owner1<span class="token punctuation">;</span>
<span class="token builtin">address</span> <span class="token keyword">public</span> owner2<span class="token punctuation">;</span>

<span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _owner1<span class="token punctuation">,</span> <span class="token builtin">address</span> _owner2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    owner1 <span class="token operator">=</span> _owner1<span class="token punctuation">;</span>
    owner2 <span class="token operator">=</span> _owner2<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And then we can implement the <code>isValidSignature</code> method in the following way:</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">isValidSignature</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _hash<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> _signature<span class="token punctuation">)</span> <span class="token keyword">public</span> override <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The signature is the concatenation of the ECDSA signatures of the owners</span>
    <span class="token comment">// Each ECDSA signature is 65 bytes long. That means that the combined signature is 130 bytes long.</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>_signature<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">130</span><span class="token punctuation">,</span> <span class="token string">'Signature length is incorrect'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">address</span> recoveredAddr1 <span class="token operator">=</span> ECDSA<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>_hash<span class="token punctuation">,</span> _signature<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">address</span> recoveredAddr2 <span class="token operator">=</span> ECDSA<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>_hash<span class="token punctuation">,</span> _signature<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">:</span><span class="token number">130</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">require</span><span class="token punctuation">(</span>recoveredAddr1 <span class="token operator">==</span> owner1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>recoveredAddr2 <span class="token operator">==</span> owner2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> EIP1271_SUCCESS_RETURN_VALUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="transaction-validation"><a href="#transaction-validation" class="header-anchor">#</a> Transaction validation</h3> <p>Let's implement the validation process. It is responsible for validating the signature of the transaction and incrementing the nonce. Note, that there are some limitations on what this method is allowed to do. You can read more about them <a href="/dev/developer-guides/aa.html#limitations-of-the-verification-step">here</a>.</p> <p>To increment the nonce, you should use the <code>incrementNonceIfEquals</code> method of the <code>NONCE_HOLDER_SYSTEM_CONTRACT</code> system contract. It takes the nonce of the transaction and checks whether the nonce is the same as the provided one. If not, the transaction reverts. Otherwise, the nonce is increased.</p> <p>Even though the requirements above allows the accounts to touch only their storage slots, accessing your nonce in the <code>NONCE_HOLDER_SYSTEM_CONTRACT</code> is a <a href="/dev/developer-guides/aa.html#extending-the-set-of-slots-that-belong-to-a-user">whitelisted</a> case, since it behaves in the same way as your storage, it just happened to be in another contract. To call the <code>NONCE_HOLDER_SYSTEM_CONTRACT</code>, you should add the following import:</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">import</span> <span class="token string">'@matterlabs/zksync-contracts/l2/system-contracts/Constants.sol'</span><span class="token punctuation">;</span>
</code></pre></div><p>The <code>TransactionHelper</code> library (already imported in the example above) can be used to get the hash of the transaction that should be signed. You can also implement your own signature scheme and use a different commitment for the transaction to sign, but in this example we use the hash provided by this library.</p> <p>Using the <code>TransactionHelper</code> library:</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">using</span> <span class="token class-name">TransactionHelper</span> <span class="token keyword">for</span> Transaction<span class="token punctuation">;</span>
</code></pre></div><p>Also, note that since the non-view methods of the <code>NONCE_HOLDER_SYSTEM_CONTRACT</code> are required to be called with the <code>isSystem</code> flag on, the <a href="https://github.com/matter-labs/v2-testnet-contracts/blob/a3cd3c557208f2cd18e12c41840c5d3728d7f71b/l2/system-contracts/SystemContractsCaller.sol#L55" target="_blank" rel="noopener noreferrer">systemCall<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> method of the <code>SystemContractsCaller</code> library should be used, so this library needs to be imported as well:</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">import</span> <span class="token string">'@matterlabs/zksync-contracts/l2/system-contracts/SystemContractsCaller.sol'</span><span class="token punctuation">;</span>
</code></pre></div><p>Now we can implement the <code>_validateTransaction</code> method:</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">_validateTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _suggestedSignedHash<span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    <span class="token comment">// Incrementing the nonce of the account.</span>
    <span class="token comment">// Note, that reserved[0] by convention is currently equal to the nonce passed in the transaction</span>
    SystemContractsCaller<span class="token punctuation">.</span><span class="token function">systemCall</span><span class="token punctuation">(</span>
        <span class="token builtin">uint32</span><span class="token punctuation">(</span><span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token builtin">address</span><span class="token punctuation">(</span>NONCE_HOLDER_SYSTEM_CONTRACT<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span>INonceHolder<span class="token punctuation">.</span>incrementMinNonceIfEquals<span class="token punctuation">,</span> <span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">bytes32</span> txHash<span class="token punctuation">;</span>
    <span class="token comment">// While the suggested signed hash is usually provided, it is generally</span>
    <span class="token comment">// not recommended to rely on it to be present, since in the future</span>
    <span class="token comment">// there may be tx types with no suggested signed hash.</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>_suggestedSignedHash <span class="token operator">==</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        txHash <span class="token operator">=</span> _transaction<span class="token punctuation">.</span><span class="token function">encodeHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        txHash <span class="token operator">=</span> _suggestedSignedHash<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">isValidSignature</span><span class="token punctuation">(</span>txHash<span class="token punctuation">,</span> _transaction<span class="token punctuation">.</span>signature<span class="token punctuation">)</span> <span class="token operator">==</span> EIP1271_SUCCESS_RETURN_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="paying-fees-for-the-transaction"><a href="#paying-fees-for-the-transaction" class="header-anchor">#</a> Paying fees for the transaction</h3> <p>We should now implement the <code>payForTransaction</code> method. The <code>TransactionHelper</code> library already provides us with the <code>payToTheBootloader</code> method, that sends <code>_transaction.maxFeePerErg * _transaction.ergsLimit</code> ETH to the bootloader. So the implementation is rather straightforward:</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">payForTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        <span class="token builtin">bool</span> success <span class="token operator">=</span> _transaction<span class="token punctuation">.</span><span class="token function">payToTheBootloader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">&quot;Failed to pay the fee to the operator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="implementing-prepaymaster"><a href="#implementing-prepaymaster" class="header-anchor">#</a> Implementing <code>prePaymaster</code></h3> <p>While generally the account abstraction protocol enables performing arbitrary actions when interacting with the paymasters, there are some <a href="/dev/developer-guides/aa.html#built-in-paymaster-flows">common patterns</a> with the built-in support from EOAs.
Unless you want to implement or restrict some specific paymaster use cases from your account, it is better to keep it consistent with EOAs. The <code>TransactionHelper</code> library provides the <code>processPaymasterInput</code> which does exactly that: processed the <code>prePaymaster</code> step the same as EOA does.</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">prePaymaster</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">,</span> Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
    _transaction<span class="token punctuation">.</span><span class="token function">processPaymasterInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="transaction-execution"><a href="#transaction-execution" class="header-anchor">#</a> Transaction execution</h3> <p>The most basic implementation of the transaction execution is quite straightforward:</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint256</span> to <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>to<span class="token punctuation">;</span>
    <span class="token comment">// By convention, the `reserved[1]` field is msg.value</span>
    <span class="token builtin">uint256</span> value <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> data <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

    <span class="token builtin">bool</span> success<span class="token punctuation">;</span>
    <span class="token keyword">assembly</span> <span class="token punctuation">{</span>
        success <span class="token operator">:=</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token function">gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mload</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Needed for the transaction to be correctly processed by the server.</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>However, note that calling ContractDeployer is only possible with the <code>isSystem</code> call flag. In order to permit your users to deploy contracts, you should do so explicitly:</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    <span class="token builtin">address</span> to <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token builtin">uint160</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">uint256</span> value <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> data <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>to <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span>DEPLOYER_SYSTEM_CONTRACT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// We allow calling ContractDeployer with any calldata</span>
        SystemContractsCaller<span class="token punctuation">.</span><span class="token function">systemCall</span><span class="token punctuation">(</span>
            <span class="token builtin">uint32</span><span class="token punctuation">(</span><span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            to<span class="token punctuation">,</span>
            <span class="token builtin">uint128</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// By convention, reserved[1] is `value`</span>
            _transaction<span class="token punctuation">.</span>data
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token builtin">bool</span> success<span class="token punctuation">;</span>
        <span class="token keyword">assembly</span> <span class="token punctuation">{</span>
            success <span class="token operator">:=</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token function">gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mload</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Note, that whether the operator will consider the transaction successful will depend only on whether the call to <code>executeTransactions</code> was successful. Therefore, it is highly recommended to put <code>require(success)</code> for the transaction, so that users get the best UX.</p> <h3 id="full-code-of-the-account"><a href="#full-code-of-the-account" class="header-anchor">#</a> Full code of the account</h3> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token comment">// SPDX-License-Identifier: MIT</span>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">&quot;@matterlabs/zksync-contracts/l2/system-contracts/interfaces/IAccount.sol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">&quot;@matterlabs/zksync-contracts/l2/system-contracts/TransactionHelper.sol&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">&quot;@openzeppelin/contracts/interfaces/IERC1271.sol&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Used for signature validation</span>
<span class="token keyword">import</span> <span class="token string">&quot;@openzeppelin/contracts/utils/cryptography/ECDSA.sol&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Access zkSync system contracts, in this case for nonce validation vs NONCE_HOLDER_SYSTEM_CONTRACT</span>
<span class="token keyword">import</span> <span class="token string">&quot;@matterlabs/zksync-contracts/l2/system-contracts/Constants.sol&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// to call non-view method of system contracts</span>
<span class="token keyword">import</span> <span class="token string">&quot;@matterlabs/zksync-contracts/l2/system-contracts/SystemContractsCaller.sol&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">TwoUserMultisig</span> <span class="token keyword">is</span> IAccount<span class="token punctuation">,</span> IERC1271 <span class="token punctuation">{</span>
    <span class="token comment">// to get transaction hash</span>
    <span class="token keyword">using</span> <span class="token class-name">TransactionHelper</span> <span class="token keyword">for</span> Transaction<span class="token punctuation">;</span>

    <span class="token comment">// state variables for account owners</span>
    <span class="token builtin">address</span> <span class="token keyword">public</span> owner1<span class="token punctuation">;</span>
    <span class="token builtin">address</span> <span class="token keyword">public</span> owner2<span class="token punctuation">;</span>

    <span class="token builtin">bytes4</span> <span class="token keyword">constant</span> EIP1271_SUCCESS_RETURN_VALUE <span class="token operator">=</span> <span class="token number">0x1626ba7e</span><span class="token punctuation">;</span>

    <span class="token keyword">modifier</span> <span class="token function">onlyBootloader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>
            msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> BOOTLOADER_FORMAL_ADDRESS<span class="token punctuation">,</span>
            <span class="token string">&quot;Only bootloader can call this method&quot;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Continure execution if called from the bootloader.</span>
        <span class="token keyword">_</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> _owner1<span class="token punctuation">,</span> <span class="token builtin">address</span> _owner2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        owner1 <span class="token operator">=</span> _owner1<span class="token punctuation">;</span>
        owner2 <span class="token operator">=</span> _owner2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">validateTransaction</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        <span class="token builtin">bytes32</span> _suggestedSignedHash<span class="token punctuation">,</span>
        Transaction <span class="token keyword">calldata</span> _transaction
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        <span class="token function">_validateTransaction</span><span class="token punctuation">(</span>_suggestedSignedHash<span class="token punctuation">,</span> _transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">_validateTransaction</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span> _suggestedSignedHash<span class="token punctuation">,</span>
        Transaction <span class="token keyword">calldata</span> _transaction
    <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
        <span class="token comment">// Incrementing the nonce of the account.</span>
        <span class="token comment">// Note, that reserved[0] by convention is currently equal to the nonce passed in the transaction</span>
        SystemContractsCaller<span class="token punctuation">.</span><span class="token function">systemCall</span><span class="token punctuation">(</span>
            <span class="token builtin">uint32</span><span class="token punctuation">(</span><span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">address</span><span class="token punctuation">(</span>NONCE_HOLDER_SYSTEM_CONTRACT<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span>
                INonceHolder<span class="token punctuation">.</span>incrementMinNonceIfEquals<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token builtin">bytes32</span> txHash<span class="token punctuation">;</span>
        <span class="token comment">// While the suggested signed hash is usually provided, it is generally</span>
        <span class="token comment">// not recommended to rely on it to be present, since in the future</span>
        <span class="token comment">// there may be tx types with no suggested signed hash.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_suggestedSignedHash <span class="token operator">==</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            txHash <span class="token operator">=</span> _transaction<span class="token punctuation">.</span><span class="token function">encodeHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            txHash <span class="token operator">=</span> _suggestedSignedHash<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">require</span><span class="token punctuation">(</span>
            <span class="token function">isValidSignature</span><span class="token punctuation">(</span>txHash<span class="token punctuation">,</span> _transaction<span class="token punctuation">.</span>signature<span class="token punctuation">)</span> <span class="token operator">==</span>
                EIP1271_SUCCESS_RETURN_VALUE
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">executeTransaction</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        Transaction <span class="token keyword">calldata</span> _transaction
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
        <span class="token builtin">address</span> to <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token builtin">uint160</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint256</span> value <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token builtin">bytes</span> <span class="token keyword">memory</span> data <span class="token operator">=</span> _transaction<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span>DEPLOYER_SYSTEM_CONTRACT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// We allow calling ContractDeployer with any calldata</span>
            SystemContractsCaller<span class="token punctuation">.</span><span class="token function">systemCall</span><span class="token punctuation">(</span>
                <span class="token builtin">uint32</span><span class="token punctuation">(</span><span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                to<span class="token punctuation">,</span>
                <span class="token builtin">uint128</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">.</span>reserved<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// By convention, reserved[1] is `value`</span>
                _transaction<span class="token punctuation">.</span>data
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token builtin">bool</span> success<span class="token punctuation">;</span>
            <span class="token keyword">assembly</span> <span class="token punctuation">{</span>
                success <span class="token operator">:=</span> <span class="token function">call</span><span class="token punctuation">(</span>
                    <span class="token function">gas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    to<span class="token punctuation">,</span>
                    value<span class="token punctuation">,</span>
                    <span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">mload</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token number">0</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">executeTransactionFromOutside</span><span class="token punctuation">(</span>Transaction <span class="token keyword">calldata</span> _transaction<span class="token punctuation">)</span>
        <span class="token keyword">external</span>
        <span class="token keyword">payable</span>
    <span class="token punctuation">{</span>
        <span class="token function">_validateTransaction</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">_executeTransaction</span><span class="token punctuation">(</span>_transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">isValidSignature</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _hash<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> _signature<span class="token punctuation">)</span>
        <span class="token keyword">public</span>
        <span class="token keyword">view</span>
        override
        <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes4</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// The signature is the concatenation of the ECDSA signatures of the owners</span>
        <span class="token comment">// Each ECDSA signature is 65 bytes long. That means that the combined signature is 130 bytes long.</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>_signature<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">130</span><span class="token punctuation">,</span> <span class="token string">&quot;Signature length is incorrect&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token builtin">address</span> recoveredAddr1 <span class="token operator">=</span> ECDSA<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>_hash<span class="token punctuation">,</span> _signature<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">address</span> recoveredAddr2 <span class="token operator">=</span> ECDSA<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>_hash<span class="token punctuation">,</span> _signature<span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">:</span><span class="token number">130</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">require</span><span class="token punctuation">(</span>recoveredAddr1 <span class="token operator">==</span> owner1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>recoveredAddr2 <span class="token operator">==</span> owner2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> EIP1271_SUCCESS_RETURN_VALUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">payForTransaction</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        Transaction <span class="token keyword">calldata</span> _transaction
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        <span class="token builtin">bool</span> success <span class="token operator">=</span> _transaction<span class="token punctuation">.</span><span class="token function">payToTheBootloader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">&quot;Failed to pay the fee to the operator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">prePaymaster</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        <span class="token builtin">bytes32</span><span class="token punctuation">,</span>
        Transaction <span class="token keyword">calldata</span> _transaction
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> override onlyBootloader <span class="token punctuation">{</span>
        _transaction<span class="token punctuation">.</span><span class="token function">processPaymasterInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span>
        <span class="token comment">// If the bootloader called the `receive` function, it likely means</span>
        <span class="token comment">// that something went wrong and the transaction should be aborted. The bootloader should</span>
        <span class="token comment">// only interact through the `validateTransaction`/`executeTransaction` methods.</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">!=</span> BOOTLOADER_FORMAL_ADDRESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="the-factory"><a href="#the-factory" class="header-anchor">#</a> The factory</h2> <p>Now, let's build a factory that can deploy these accounts. Note, that if we want to deploy AA, we need to interact directly with the <code>DEPLOYER_SYSTEM_CONTRACT</code>. For deterministic addresses, we will use <code>create2Account</code> method.</p> <p>The code will look the following way:</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token comment">// SPDX-License-Identifier: MIT</span>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">'@matterlabs/zksync-contracts/l2/system-contracts/Constants.sol'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">'@matterlabs/zksync-contracts/l2/system-contracts/SystemContractsCaller.sol'</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">AAFactory</span> <span class="token punctuation">{</span>
    <span class="token builtin">bytes32</span> <span class="token keyword">public</span> aaBytecodeHash<span class="token punctuation">;</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _aaBytecodeHash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        aaBytecodeHash <span class="token operator">=</span> _aaBytecodeHash<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">deployAccount</span><span class="token punctuation">(</span>
        <span class="token builtin">bytes32</span> salt<span class="token punctuation">,</span>
        <span class="token builtin">address</span> owner1<span class="token punctuation">,</span>
        <span class="token builtin">address</span> owner2
    <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">address</span> accountAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">bytes</span> <span class="token keyword">memory</span> returnData <span class="token operator">=</span> SystemContractsCaller<span class="token punctuation">.</span><span class="token function">systemCall</span><span class="token punctuation">(</span>
            <span class="token builtin">uint32</span><span class="token punctuation">(</span><span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">address</span><span class="token punctuation">(</span>DEPLOYER_SYSTEM_CONTRACT<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token number">0</span><span class="token punctuation">,</span>
            abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span>
                DEPLOYER_SYSTEM_CONTRACT<span class="token punctuation">.</span>create2Account<span class="token punctuation">,</span>
                <span class="token punctuation">(</span>salt<span class="token punctuation">,</span> aaBytecodeHash<span class="token punctuation">,</span> abi<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>owner1<span class="token punctuation">,</span> owner2<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">(</span>accountAddress<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>returnData<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">,</span> <span class="token builtin">bytes</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Note, that on zkSync, the deployment is not done via bytecode, but via bytecode hash. The bytecode itself is passed to the operator via <code>factoryDeps</code> field. Note, that the <code>_aaBytecodeHash</code> must be formed specially:</p> <ul><li>Firstly, it is hashed with sha256.</li> <li>Then, the first two bytes are replaced with the length of the bytecode in 32-byte words.</li></ul> <p>You don't need to worry about it, since our SDK provides a built-in method to do it, explained below.</p> <h2 id="deploying-the-factory"><a href="#deploying-the-factory" class="header-anchor">#</a> Deploying the factory</h2> <p>To deploy a factory, we need to create a deployment script. Create the <code>deploy</code> folder and create one file there: <code>deploy-factory.ts</code>. Put the following deployment script there:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> utils<span class="token punctuation">,</span> Wallet <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;zksync-web3&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> ethers <span class="token keyword">from</span> <span class="token string">&quot;ethers&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HardhatRuntimeEnvironment <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;hardhat/types&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Deployer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@matterlabs/hardhat-zksync-deploy&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>hre<span class="token operator">:</span> HardhatRuntimeEnvironment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> wallet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wallet</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;PRIVATE-KEY&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> deployer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Deployer</span><span class="token punctuation">(</span>hre<span class="token punctuation">,</span> wallet<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> factoryArtifact <span class="token operator">=</span> <span class="token keyword">await</span> deployer<span class="token punctuation">.</span><span class="token function">loadArtifact</span><span class="token punctuation">(</span><span class="token string">&quot;AAFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> aaArtifact <span class="token operator">=</span> <span class="token keyword">await</span> deployer<span class="token punctuation">.</span><span class="token function">loadArtifact</span><span class="token punctuation">(</span><span class="token string">&quot;TwoUserMultisig&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Deposit some funds to L2 in order to be able to perform L2 transactions.</span>
  <span class="token comment">// You can remove the depositing step if the `wallet` has enough funds on zkSync</span>
  <span class="token keyword">const</span> depositAmount <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">&quot;0.001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> depositHandle <span class="token operator">=</span> <span class="token keyword">await</span> deployer<span class="token punctuation">.</span>zkWallet<span class="token punctuation">.</span><span class="token function">deposit</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    to<span class="token operator">:</span> deployer<span class="token punctuation">.</span>zkWallet<span class="token punctuation">.</span>address<span class="token punctuation">,</span>
    token<span class="token operator">:</span> utils<span class="token punctuation">.</span><span class="token constant">ETH_ADDRESS</span><span class="token punctuation">,</span>
    amount<span class="token operator">:</span> depositAmount<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> depositHandle<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Getting the bytecodeHash of the account</span>
  <span class="token keyword">const</span> bytecodeHash <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">hashBytecode</span><span class="token punctuation">(</span>aaArtifact<span class="token punctuation">.</span>bytecode<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> factory <span class="token operator">=</span> <span class="token keyword">await</span> deployer<span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span>factoryArtifact<span class="token punctuation">,</span> <span class="token punctuation">[</span>bytecodeHash<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
    <span class="token comment">// Since the factory requires the code of the multisig to be available,</span>
    <span class="token comment">// we should pass it here as well.</span>
    aaArtifact<span class="token punctuation">.</span>bytecode<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">AA factory address: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>factory<span class="token punctuation">.</span>address<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In order to deploy the factory, you should compile the contracts and run the script:</p> <div class="language- extra-class"><pre class="language-text"><code>yarn hardhat compile
yarn hardhat deploy-zksync --script deploy-factory.ts
</code></pre></div><p>The output should be roughly the following:</p> <div class="language- extra-class"><pre class="language-text"><code>AA factory address: 0x9db333Cb68Fb6D317E3E415269a5b9bE7c72627Ds
</code></pre></div><p>Note that the address will be different for each run.</p> <h2 id="working-with-accounts"><a href="#working-with-accounts" class="header-anchor">#</a> Working with accounts</h2> <h3 id="deploying-an-account"><a href="#deploying-an-account" class="header-anchor">#</a> Deploying an account</h3> <p>Now, let's deploy an account and initiate a new transaction with it. In this section, we assume that you already have an EOA account with enough funds on zkSync.
In the <code>deploy</code>, folder creates a file <code>deploy-multisig.ts</code>, where we will put the script.</p> <p>Firstly, let's deploy the AA. This will be a call to the <code>deployAccount</code> function:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> utils<span class="token punctuation">,</span> Wallet<span class="token punctuation">,</span> Provider<span class="token punctuation">,</span> EIP712Signer<span class="token punctuation">,</span> types <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;zksync-web3&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> ethers <span class="token keyword">from</span> <span class="token string">&quot;ethers&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HardhatRuntimeEnvironment <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;hardhat/types&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Put the address of your AA factory</span>
<span class="token keyword">const</span> <span class="token constant">AA_FACTORY_ADDRESS</span> <span class="token operator">=</span> <span class="token string">&quot;&lt;YOUR_FACTORY_ADDRESS&gt;&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// An example of a deploy script deploys and calls a simple contract.</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>hre<span class="token operator">:</span> HardhatRuntimeEnvironment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Provider</span><span class="token punctuation">(</span>hre<span class="token punctuation">.</span>config<span class="token punctuation">.</span>zkSyncDeploy<span class="token punctuation">.</span>zkSyncNetwork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> wallet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wallet</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;PRIVATE-KEY&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> factoryArtifact <span class="token operator">=</span> <span class="token keyword">await</span> hre<span class="token punctuation">.</span>artifacts<span class="token punctuation">.</span><span class="token function">readArtifact</span><span class="token punctuation">(</span><span class="token string">&quot;AAFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> aaFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers</span><span class="token punctuation">.</span><span class="token function">Contract</span><span class="token punctuation">(</span><span class="token constant">AA_FACTORY_ADDRESS</span><span class="token punctuation">,</span> factoryArtifact<span class="token punctuation">.</span>abi<span class="token punctuation">,</span> wallet<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The two owners of the multisig</span>
  <span class="token keyword">const</span> owner1 <span class="token operator">=</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> owner2 <span class="token operator">=</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// For the simplicity of the tutorial, we will use zero hash as salt</span>
  <span class="token keyword">const</span> salt <span class="token operator">=</span> ethers<span class="token punctuation">.</span>constants<span class="token punctuation">.</span>HashZero<span class="token punctuation">;</span>

  <span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span><span class="token function">deployAccount</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> owner1<span class="token punctuation">.</span>address<span class="token punctuation">,</span> owner2<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> tx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Getting the address of the deployed contract</span>
  <span class="token keyword">const</span> abiCoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">AbiCoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> multisigAddress <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">create2Address</span><span class="token punctuation">(</span>
    <span class="token constant">AA_FACTORY_ADDRESS</span><span class="token punctuation">,</span>
    <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span><span class="token function">aaBytecodeHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    salt<span class="token punctuation">,</span>
    abiCoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;address&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>owner1<span class="token punctuation">.</span>address<span class="token punctuation">,</span> owner2<span class="token punctuation">.</span>address<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Deployed on address </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>multisigAddress<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><em>Note, that zkSync has different address derivation rules from Ethereum</em>. You should always use the <code>createAddress</code> and <code>create2Address</code> utility methods of the <code>zksync-web3</code> SDK.</p> <h3 id="starting-a-transaction-from-this-account"><a href="#starting-a-transaction-from-this-account" class="header-anchor">#</a> Starting a transaction from this account</h3> <p>Before the deployed account can do any transactions, we need to top it up:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">await</span><span class="token punctuation">(</span>
  <span class="token keyword">await</span> wallet<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    to<span class="token operator">:</span> multisigAddress<span class="token punctuation">,</span>
    <span class="token comment">// You can increase the amount of ETH sent to the multisig</span>
    value<span class="token operator">:</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">&quot;0.003&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now, as an example, let's try to deploy a new multisig, but the initiator of the transaction will be our deployed account from the previous part:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">let</span> aaTx <span class="token operator">=</span> <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span>populateTransaction<span class="token punctuation">.</span><span class="token function">deployAccount</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address<span class="token punctuation">,</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Then, we need to fill all the transaction fields:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> gasLimit <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">estimateGas</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> gasPrice <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getGasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

aaTx <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>aaTx<span class="token punctuation">,</span>
  from<span class="token operator">:</span> multisigAddress<span class="token punctuation">,</span>
  gasLimit<span class="token operator">:</span> gasLimit<span class="token punctuation">,</span>
  gasPrice<span class="token operator">:</span> gasPrice<span class="token punctuation">,</span>
  chainId<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getNetwork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>chainId<span class="token punctuation">,</span>
  nonce<span class="token operator">:</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> <span class="token number">113</span><span class="token punctuation">,</span>
  customData<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// Note, that we are using the `DEFAULT_ERGS_PER_PUBDATA_LIMIT`</span>
    ergsPerPubdata<span class="token operator">:</span> utils<span class="token punctuation">.</span><span class="token constant">DEFAULT_ERGS_PER_PUBDATA_LIMIT</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token keyword">as</span> types<span class="token punctuation">.</span>Eip712Meta<span class="token punctuation">,</span>
  value<span class="token operator">:</span> ethers<span class="token punctuation">.</span>BigNumber<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Note on gasLimit</p> <p>Currently, we expect the <code>gasLimit</code> to cover both the verification and the execution steps. Currently, the number of ergs that is returned by the <code>estimateGas</code> is <code>execution_ergs + 20000</code>, where <code>20000</code> is roughly equal to the overhead needed for the defaultAA to have both fee charged and the signature verified. In case your AA has a very expensive verification step, you should add some constant to the <code>gasLimit</code>.</p></div> <p>Then, we need to sign the transaction and provide the <code>aaParamas</code> in the customData of the transaction:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> signedTxHash <span class="token operator">=</span> EIP712Signer<span class="token punctuation">.</span><span class="token function">getSignedDigest</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> signature <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token comment">// Note, that `signMessage` wouldn't work here, since we don't want</span>
  <span class="token comment">// the signed hash to be prefixed with `\x19Ethereum Signed Message:\n`</span>
  ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">joinSignature</span><span class="token punctuation">(</span>owner1<span class="token punctuation">.</span><span class="token function">_signingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signDigest</span><span class="token punctuation">(</span>signedTxHash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">joinSignature</span><span class="token punctuation">(</span>owner2<span class="token punctuation">.</span><span class="token function">_signingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signDigest</span><span class="token punctuation">(</span>signedTxHash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

aaTx<span class="token punctuation">.</span>customData <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>aaTx<span class="token punctuation">.</span>customData<span class="token punctuation">,</span>
  customSignature<span class="token operator">:</span> signature<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Now, we are ready to send the transaction:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The multisig's nonce before the first tx is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sentTx <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span>utils<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> sentTx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Checking that the nonce for the account has increased</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The multisig's nonce after the first tx is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="full-example"><a href="#full-example" class="header-anchor">#</a> Full example</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> utils<span class="token punctuation">,</span> Wallet<span class="token punctuation">,</span> Provider<span class="token punctuation">,</span> EIP712Signer<span class="token punctuation">,</span> types <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;zksync-web3&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> ethers <span class="token keyword">from</span> <span class="token string">&quot;ethers&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HardhatRuntimeEnvironment <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;hardhat/types&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Put the address of your AA factory</span>
<span class="token keyword">const</span> <span class="token constant">AA_FACTORY_ADDRESS</span> <span class="token operator">=</span> <span class="token string">&quot;&lt;YOUR_FACTORY_ADDRESS&gt;&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>hre<span class="token operator">:</span> HardhatRuntimeEnvironment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Provider</span><span class="token punctuation">(</span>hre<span class="token punctuation">.</span>config<span class="token punctuation">.</span>zkSyncDeploy<span class="token punctuation">.</span>zkSyncNetwork<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> wallet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wallet</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;YOUR_PRIVATE_KEY&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> factoryArtifact <span class="token operator">=</span> <span class="token keyword">await</span> hre<span class="token punctuation">.</span>artifacts<span class="token punctuation">.</span><span class="token function">readArtifact</span><span class="token punctuation">(</span><span class="token string">&quot;AAFactory&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> aaFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers</span><span class="token punctuation">.</span><span class="token function">Contract</span><span class="token punctuation">(</span><span class="token constant">AA_FACTORY_ADDRESS</span><span class="token punctuation">,</span> factoryArtifact<span class="token punctuation">.</span>abi<span class="token punctuation">,</span> wallet<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The two owners of the multisig</span>
  <span class="token keyword">const</span> owner1 <span class="token operator">=</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> owner2 <span class="token operator">=</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// For the simplicity of the tutorial, we will use zero hash as salt</span>
  <span class="token keyword">const</span> salt <span class="token operator">=</span> ethers<span class="token punctuation">.</span>constants<span class="token punctuation">.</span>HashZero<span class="token punctuation">;</span>

  <span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span><span class="token function">deployAccount</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> owner1<span class="token punctuation">.</span>address<span class="token punctuation">,</span> owner2<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> tx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Getting the address of the deployed contract</span>
  <span class="token keyword">const</span> abiCoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ethers</span><span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">AbiCoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> multisigAddress <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">create2Address</span><span class="token punctuation">(</span>
    <span class="token constant">AA_FACTORY_ADDRESS</span><span class="token punctuation">,</span>
    <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span><span class="token function">aaBytecodeHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    salt<span class="token punctuation">,</span>
    abiCoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;address&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>owner1<span class="token punctuation">.</span>address<span class="token punctuation">,</span> owner2<span class="token punctuation">.</span>address<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Multisig deployed on address </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>multisigAddress<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> <span class="token punctuation">(</span>
    <span class="token keyword">await</span> wallet<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      to<span class="token operator">:</span> multisigAddress<span class="token punctuation">,</span>
      <span class="token comment">// You can increase the amount of ETH sent to the multisig</span>
      value<span class="token operator">:</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">parseEther</span><span class="token punctuation">(</span><span class="token string">&quot;0.001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> aaTx <span class="token operator">=</span> <span class="token keyword">await</span> aaFactory<span class="token punctuation">.</span>populateTransaction<span class="token punctuation">.</span><span class="token function">deployAccount</span><span class="token punctuation">(</span>salt<span class="token punctuation">,</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address<span class="token punctuation">,</span> Wallet<span class="token punctuation">.</span><span class="token function">createRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> gasLimit <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">estimateGas</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> gasPrice <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getGasPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  aaTx <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>aaTx<span class="token punctuation">,</span>
    from<span class="token operator">:</span> multisigAddress<span class="token punctuation">,</span>
    gasLimit<span class="token operator">:</span> gasLimit<span class="token punctuation">,</span>
    gasPrice<span class="token operator">:</span> gasPrice<span class="token punctuation">,</span>
    chainId<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getNetwork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>chainId<span class="token punctuation">,</span>
    nonce<span class="token operator">:</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token number">113</span><span class="token punctuation">,</span>
    customData<span class="token operator">:</span> <span class="token punctuation">{</span>
      ergsPerPubdata<span class="token operator">:</span> utils<span class="token punctuation">.</span><span class="token constant">DEFAULT_ERGS_PER_PUBDATA_LIMIT</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token keyword">as</span> types<span class="token punctuation">.</span>Eip712Meta<span class="token punctuation">,</span>
    value<span class="token operator">:</span> ethers<span class="token punctuation">.</span>BigNumber<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> signedTxHash <span class="token operator">=</span> EIP712Signer<span class="token punctuation">.</span><span class="token function">getSignedDigest</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> signature <span class="token operator">=</span> ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token comment">// Note, that `signMessage` wouldn't work here, since we don't want</span>
    <span class="token comment">// the signed hash to be prefixed with `\x19Ethereum Signed Message:\n`</span>
    ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">joinSignature</span><span class="token punctuation">(</span>owner1<span class="token punctuation">.</span><span class="token function">_signingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signDigest</span><span class="token punctuation">(</span>signedTxHash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    ethers<span class="token punctuation">.</span>utils<span class="token punctuation">.</span><span class="token function">joinSignature</span><span class="token punctuation">(</span>owner2<span class="token punctuation">.</span><span class="token function">_signingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">signDigest</span><span class="token punctuation">(</span>signedTxHash<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  aaTx<span class="token punctuation">.</span>customData <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>aaTx<span class="token punctuation">.</span>customData<span class="token punctuation">,</span>
    customSignature<span class="token operator">:</span> signature<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The multisig's nonce before the first tx is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sentTx <span class="token operator">=</span> <span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span>utils<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>aaTx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> sentTx<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Checking that the nonce for the account has increased</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The multisig's nonce after the first tx is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">await</span> provider<span class="token punctuation">.</span><span class="token function">getTransactionCount</span><span class="token punctuation">(</span>multisigAddress<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>To run the script, use the following command:</p> <div class="language- extra-class"><pre class="language-text"><code>yarn hardhat deploy-zksync --script deploy-multisig.ts
</code></pre></div><p>The output should be roughly the following:</p> <div class="language- extra-class"><pre class="language-text"><code>Multisig deployed on address 0xCEBc59558938bccb43A6C94769F87bBdb770E956
The multisig's nonce before the first tx is 0
The multisig's nonce after the first tx is 1
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>If you get an error <code>Not enough balance to cover the fee.</code>, try increasing the amount of ETH sent to the multisig wallet so it has enough funds to pay for the transaction fees.</p></div> <h2 id="complete-project"><a href="#complete-project" class="header-anchor">#</a> Complete project</h2> <p>You can download the complete project <a href="https://github.com/matter-labs/custom-aa-tutorial" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="learn-more"><a href="#learn-more" class="header-anchor">#</a> Learn more</h2> <ul><li>To learn more about L1-&gt;L2 interaction on zkSync, check out the <a href="/dev/developer-guides/bridging/l1-l2.html">documentation</a>.</li> <li>To learn more about the <code>zksync-web3</code> SDK, check out its <a href="../../api/js">documentation</a>.</li> <li>To learn more about the zkSync hardhat plugins, check out their <a href="../../api/hardhat">documentation</a>.</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/matter-labs/zksync-web-v2-docs/edit/main/docs/dev/tutorials/custom-aa-tutorial.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/22/2022, 2:51:27 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/dev/tutorials/cross-chain-tutorial.html" class="prev">
        Cross-chain governance
      </a></span> <span class="next"><a href="/dev/tutorials/custom-paymaster-tutorial.html">
        Building custom paymaster
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.7b8ca578.js" defer></script><script src="/assets/js/2.5a73362d.js" defer></script><script src="/assets/js/73.0d4f65f9.js" defer></script>
  </body>
</html>
