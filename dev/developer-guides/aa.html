<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Account abstraction support | zkSync — Accelerating the mass adoption of crypto for personal sovereignty</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script src="/__/firebase/7.13.2/firebase-app.js" defer="true"></script>
    <script src="/__/firebase/7.13.2/firebase-analytics.js" defer="true"></script>
    <script src="/__/firebase/init.js" defer="true"></script>
    <script>
  const logoUrlChanger = setInterval(function() {
    //Anchor above the logo image
    const homeEls = document.getElementsByClassName("home-link");
    if(homeEls.length > 0) {
      const homeEl = homeEls[0];
      homeEl.setAttribute("href", "https://zksync.io");
      homeEl.setAttribute("onclick", "document.location='https://zksync.io';return false;");
      clearInterval(logoUrlChanger);
    }

    //Actual logo image
    const logoEls = document.getElementsByClassName("logo")
    if(logoEls.length > 0) {
      const logoEl = logoEls[0]
      logoEl.setAttribute("onclick", "document.location='https://zksync.io';return false;");
      clearInterval(logoUrlChanger);
    }
  }, 1000)</script>
    <meta name="description" content="zkSync is a ZK rollup that represents the end-game for scaling Ethereum - one that scales its technology and values without degrading security or decentralization">
    
    <link rel="preload" href="/assets/css/0.styles.350a0b01.css" as="style"><link rel="preload" href="/assets/js/app.c6cf46ce.js" as="script"><link rel="preload" href="/assets/js/2.5a73362d.js" as="script"><link rel="preload" href="/assets/js/45.e4e94522.js" as="script"><link rel="prefetch" href="/assets/js/10.1d31b665.js"><link rel="prefetch" href="/assets/js/11.1157f03f.js"><link rel="prefetch" href="/assets/js/12.d33546da.js"><link rel="prefetch" href="/assets/js/13.723b8044.js"><link rel="prefetch" href="/assets/js/14.0c7cfd9a.js"><link rel="prefetch" href="/assets/js/15.94b050a9.js"><link rel="prefetch" href="/assets/js/16.e6a47b37.js"><link rel="prefetch" href="/assets/js/17.b8d9f9d6.js"><link rel="prefetch" href="/assets/js/18.0b30ca48.js"><link rel="prefetch" href="/assets/js/19.766c20d3.js"><link rel="prefetch" href="/assets/js/20.460bc0dc.js"><link rel="prefetch" href="/assets/js/21.fb191a53.js"><link rel="prefetch" href="/assets/js/22.afbb198e.js"><link rel="prefetch" href="/assets/js/23.361781f0.js"><link rel="prefetch" href="/assets/js/24.f13edcf9.js"><link rel="prefetch" href="/assets/js/25.988d1b47.js"><link rel="prefetch" href="/assets/js/26.d9a5b96d.js"><link rel="prefetch" href="/assets/js/27.021584cb.js"><link rel="prefetch" href="/assets/js/28.96f99bb5.js"><link rel="prefetch" href="/assets/js/29.2a268b12.js"><link rel="prefetch" href="/assets/js/3.e113e3f2.js"><link rel="prefetch" href="/assets/js/30.7984b785.js"><link rel="prefetch" href="/assets/js/31.8af0f6d4.js"><link rel="prefetch" href="/assets/js/32.69f0eb35.js"><link rel="prefetch" href="/assets/js/33.ce141b46.js"><link rel="prefetch" href="/assets/js/34.436c44f6.js"><link rel="prefetch" href="/assets/js/35.31ad6a43.js"><link rel="prefetch" href="/assets/js/36.2da22722.js"><link rel="prefetch" href="/assets/js/37.1bb4c43e.js"><link rel="prefetch" href="/assets/js/38.56f7eac2.js"><link rel="prefetch" href="/assets/js/39.8eb128c5.js"><link rel="prefetch" href="/assets/js/4.f9a9a52f.js"><link rel="prefetch" href="/assets/js/40.19d448e8.js"><link rel="prefetch" href="/assets/js/41.54fc32f5.js"><link rel="prefetch" href="/assets/js/42.c7a15e4d.js"><link rel="prefetch" href="/assets/js/43.7e116cdb.js"><link rel="prefetch" href="/assets/js/44.15b74555.js"><link rel="prefetch" href="/assets/js/46.2a43ffcf.js"><link rel="prefetch" href="/assets/js/47.48940a6c.js"><link rel="prefetch" href="/assets/js/48.4522a9da.js"><link rel="prefetch" href="/assets/js/49.2a6881e2.js"><link rel="prefetch" href="/assets/js/5.300f03dd.js"><link rel="prefetch" href="/assets/js/50.7dcd49ad.js"><link rel="prefetch" href="/assets/js/51.1caf73f6.js"><link rel="prefetch" href="/assets/js/52.edaae008.js"><link rel="prefetch" href="/assets/js/53.c8ac7f10.js"><link rel="prefetch" href="/assets/js/54.32be413d.js"><link rel="prefetch" href="/assets/js/55.dfefd250.js"><link rel="prefetch" href="/assets/js/56.71b0a9a6.js"><link rel="prefetch" href="/assets/js/57.fc29b145.js"><link rel="prefetch" href="/assets/js/58.33699426.js"><link rel="prefetch" href="/assets/js/59.f507982b.js"><link rel="prefetch" href="/assets/js/6.89aee1c7.js"><link rel="prefetch" href="/assets/js/60.6fafd85a.js"><link rel="prefetch" href="/assets/js/61.ed3ce206.js"><link rel="prefetch" href="/assets/js/62.92650c1b.js"><link rel="prefetch" href="/assets/js/63.133469b1.js"><link rel="prefetch" href="/assets/js/64.0d71a30f.js"><link rel="prefetch" href="/assets/js/65.80803858.js"><link rel="prefetch" href="/assets/js/66.27a08873.js"><link rel="prefetch" href="/assets/js/67.45bb751b.js"><link rel="prefetch" href="/assets/js/68.c6fed9d6.js"><link rel="prefetch" href="/assets/js/69.937986ed.js"><link rel="prefetch" href="/assets/js/7.9cb55bb9.js"><link rel="prefetch" href="/assets/js/70.25b1f05d.js"><link rel="prefetch" href="/assets/js/71.6812e6cd.js"><link rel="prefetch" href="/assets/js/72.dc598d21.js"><link rel="prefetch" href="/assets/js/73.f7d09f08.js"><link rel="prefetch" href="/assets/js/74.8b4800dc.js"><link rel="prefetch" href="/assets/js/75.25971604.js"><link rel="prefetch" href="/assets/js/76.1dd3556b.js"><link rel="prefetch" href="/assets/js/8.f9eaafb5.js"><link rel="prefetch" href="/assets/js/9.2e9fb4a6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.350a0b01.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/LogotypeLight.svg" alt="zkSync — Accelerating the mass adoption of crypto for personal sovereignty" class="logo"> <span class="site-name can-hide">zkSync — Accelerating the mass adoption of crypto for personal sovereignty</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/dev/" class="nav-link router-link-active">
  Developer Docs
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  Tools/SDKs
</a></div><div class="nav-item"><a href="/contact.html" class="nav-link">
  Contact
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="v2.0" class="dropdown-title"><span class="title">v2.0</span> <span class="arrow down"></span></button> <button type="button" aria-label="v2.0" class="mobile-dropdown-title"><span class="title">v2.0</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/dev/" class="nav-link router-link-active">
  v2.0
</a></li><li class="dropdown-item"><!----> <a href="https://docs.zksync.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v1.x
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/matter-labs/zksync-web-v2-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/dev/" class="nav-link router-link-active">
  Developer Docs
</a></div><div class="nav-item"><a href="/api/" class="nav-link">
  Tools/SDKs
</a></div><div class="nav-item"><a href="/contact.html" class="nav-link">
  Contact
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="v2.0" class="dropdown-title"><span class="title">v2.0</span> <span class="arrow down"></span></button> <button type="button" aria-label="v2.0" class="mobile-dropdown-title"><span class="title">v2.0</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/dev/" class="nav-link router-link-active">
  v2.0
</a></li><li class="dropdown-item"><!----> <a href="https://docs.zksync.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v1.x
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/matter-labs/zksync-web-v2-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/dev/" aria-current="page" class="sidebar-link">Introduction</a></li><li><section class="sidebar-group depth-0"><a href="/dev/fundamentals" class="sidebar-heading clickable"><span>Getting started</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/fundamentals/rollups.html" class="sidebar-link">rollups 介绍</a></li><li><a href="/dev/fundamentals/zkSync.html" class="sidebar-link">zkSync 基础知识</a></li><li><a href="/dev/fundamentals/testnet.html" class="sidebar-link">zkSync 测试网</a></li><li><a href="/dev/fundamentals/faq.html" class="sidebar-link">FAQ</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/dev/developer-guides" class="sidebar-heading clickable router-link-active open"><span>Understanding zkSync</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/developer-guides/transactions/transactions.html" class="sidebar-link">Transactions</a></li><li><a href="/dev/developer-guides/transactions/blocks.html" class="sidebar-link">Blocks</a></li><li><a href="/dev/developer-guides/contracts/system-contracts.html" class="sidebar-link">System contracts</a></li><li><a href="/dev/developer-guides/aa.html" aria-current="page" class="active sidebar-link">Account abstraction support</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dev/developer-guides/aa.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/dev/developer-guides/aa.html#design" class="sidebar-link">Design</a></li><li class="sidebar-sub-header"><a href="/dev/developer-guides/aa.html#using-the-systemcontractscaller-library" class="sidebar-link">Using the SystemContractsCaller library</a></li><li class="sidebar-sub-header"><a href="/dev/developer-guides/aa.html#extending-eip4337" class="sidebar-link">Extending EIP4337</a></li><li class="sidebar-sub-header"><a href="/dev/developer-guides/aa.html#building-custom-accounts" class="sidebar-link">Building custom accounts</a></li><li class="sidebar-sub-header"><a href="/dev/developer-guides/aa.html#paymasters" class="sidebar-link">Paymasters</a></li><li class="sidebar-sub-header"><a href="/dev/developer-guides/aa.html#aa-signature-checker" class="sidebar-link">aa-signature-checker</a></li><li class="sidebar-sub-header"><a href="/dev/developer-guides/aa.html#verifying-aa-signatures-within-our-sdk" class="sidebar-link">Verifying AA signatures within our SDK</a></li></ul></li><li><a href="/dev/developer-guides/security.html" class="sidebar-link">Security model</a></li><li><a href="/dev/developer-guides/transactions/fee-model.html" class="sidebar-link">Fee mechanism</a></li><li><a href="/dev/developer-guides/bridging/bridging-asset.html" class="sidebar-link">Bridging assets</a></li><li><a href="/dev/developer-guides/bridging/l1-l2-interop.html" class="sidebar-link">L1 / L2 Interoperability</a></li><li><a href="/dev/developer-guides/bridging/l1-l2.html" class="sidebar-link">L1 -&gt; L2 communication</a></li><li><a href="/dev/developer-guides/bridging/l2-l1.html" class="sidebar-link">L2 -&gt; L1 communication</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/dev/developer-guides/building-on-zksync" class="sidebar-heading clickable"><span>Building on zkSync</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/developer-guides/hello-world.html" class="sidebar-link">Quickstart</a></li><li><a href="/dev/developer-guides/contracts/contracts.html" class="sidebar-link">Contract deployment</a></li><li><a href="/dev/developer-guides/contracts/contract-verification.html" class="sidebar-link">Verify smart contracts</a></li><li><a href="/dev/developer-guides/building-on-zksync/events.html" class="sidebar-link">Handling events</a></li><li><a href="/dev/developer-guides/building-on-zksync/rpc.html" class="sidebar-link">JSON-RPC API</a></li><li><a href="/dev/developer-guides/building-on-zksync/videos.html" class="sidebar-link">Video resources</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/dev/tutorials" class="sidebar-heading clickable"><span>Tutorials</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/tutorials/cross-chain-tutorial.html" class="sidebar-link">Cross-chain governance</a></li><li><a href="/dev/tutorials/custom-aa-tutorial.html" class="sidebar-link">Account abstraction</a></li><li><a href="/dev/tutorials/custom-paymaster-tutorial.html" class="sidebar-link">Building custom paymaster</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/dev/troubleshooting" class="sidebar-heading clickable"><span>Troubleshooting</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/troubleshooting/important-links.html" class="sidebar-link">Important links</a></li><li><a href="/dev/troubleshooting/status.html" class="sidebar-link">Feature support status</a></li><li><a href="/dev/troubleshooting/docs-contribution/docs.html" class="sidebar-link">文档贡献指南</a></li><li><a href="/dev/troubleshooting/docs-contribution/community-resources.html" class="sidebar-link">Community resources</a></li><li><a href="/dev/troubleshooting/known-issues.html" class="sidebar-link">Known issues</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="account-abstraction-support"><a href="#account-abstraction-support" class="header-anchor">#</a> Account abstraction support</h1> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>On Ethereum there are two types of accounts: <a href="https://ethereum.org/en/developers/docs/accounts/#externally-owned-accounts-and-key-pairs" target="_blank" rel="noopener noreferrer">externally owned accounts (EOAs)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="https://ethereum.org/en/developers/docs/accounts/#contract-accounts" target="_blank" rel="noopener noreferrer">contracts accounts<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.
The former type is the only one that can initiate transactions,
while the latter is the only one that can implement arbitrary logic. For some use-cases, like smart-contract wallets or privacy protocols, this difference can create a lot of friction.
As a result, such applications require L1 relayers, e.g. an EOA to help facilitate transactions from a smart-contract wallet.</p> <p>Accounts in zkSync 2.0 can initiate transactions, like an EOA, but can also have arbitrary logic implemented in them, like a smart contract. This feature is called &quot;account
abstraction&quot; and it aims to resolve the issues described above.</p> <div class="custom-block warning"><p class="custom-block-title">Unstable feature</p> <p>This is the test release of account abstraction (AA) on zkSync 2.0. We are very happy to hear your feedback! Please note: <strong>breaking changes to the API/interfaces required for AA should be anticipated.</strong></p> <p>zkSync 2.0 is one of the first EVM-compatible chains to adopt AA, so this testnet is also used to see how &quot;classical&quot; projects from EVM chains can coexist with the account abstraction feature.</p></div> <h3 id="prerequisites"><a href="#prerequisites" class="header-anchor">#</a> Prerequisites</h3> <p>To better understand this page, we recommend you take some time to first read a guide on <a href="https://ethereum.org/en/developers/docs/accounts/" target="_blank" rel="noopener noreferrer">accounts<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="design"><a href="#design" class="header-anchor">#</a> Design</h2> <p>The account abstraction protocol on zkSync is very similar to <a href="https://eips.ethereum.org/EIPS/eip-4337" target="_blank" rel="noopener noreferrer">EIP4337<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, though our protocol is still different for the sake of efficiency and better UX.</p> <h3 id="keeping-nonces-unique"><a href="#keeping-nonces-unique" class="header-anchor">#</a> Keeping nonces unique</h3> <div class="custom-block warning"><p class="custom-block-title">Changes are expected</p> <p>The current model has some important drawbacks: it does not allow custom wallets to send multiple transactions at the same time, while keeping a deterministic ordering. For
EOAs the nonces are expected to be sequentially growing, while for the custom accounts the order of transactions can not be determined for sure.</p> <p>In the future, we plan to switch to a model where the accounts could choose whether they would want to have sequential nonce ordering (the same as EOA) or they want to have arbitrary ordering.</p></div> <p>One of the important invariants of every blockchain is that each transaction has a unique hash. Holding this property with an arbitrary account abstraction is not trivial,
though accounts can, in general, accept multiple identical transactions. Even though these transactions would be technically valid by the rules of the blockchain, violating
hash uniqueness would be very hard for indexers and other tools to process.</p> <p>There needs to be a solution on the protocol level that is both cheap for users and robust in case of a malicious operator. One of the easiest ways to ensure that transaction hashes do not repeat is to have a pair (sender, nonce) always unique.</p> <p>The following protocol is used:</p> <ul><li>Before each transaction starts, the system queries the <a href="/dev/developer-guides/contracts/system-contracts.html#inonceholder">NonceHolder</a> to check whether the provided nonce has already been used or not.</li> <li>If the nonce has not been used yet, the transaction validation is run. The provided nonce is expected to be marked as &quot;used&quot; during this time.</li> <li>After the validation, the system checks whether this nonce is now marked as used.</li></ul> <p>Users will be allowed to use any 256-bit number as nonce and they can put any non-zero value under the corresponding key in the system contract. This is already supported by
the protocol, but not on the server side.</p> <p>More documentation on various interactions with the <code>NonceHolder</code> system contract as well as tutorials will be available once support on the server side is released. For now,
it is recommended to only use the <code>incrementNonceIfEquals</code> method, which practically enforces the sequential ordering of nonces.</p> <h3 id="standardizing-transaction-hashes"><a href="#standardizing-transaction-hashes" class="header-anchor">#</a> Standardizing transaction hashes</h3> <p>In the future, it is planned to support efficient proofs of transaction inclusion on zkSync. This would require us to calculate the transaction's hash in the [bootloader](..
/contracts/system-contracts.md#bootloader). Since these calculations won't be free to the user, it is only fair to include the transaction's hash in the interface of the AA
methods (in case the accounts may need this value for some reason). That's why all the methods of the <code>IAccount</code> and <code>IPaymaster</code> interfaces, which are described below,
contain the hash of the transaction as well as the recommended signed digest (the digest that is signed by EOAs for this transaction).</p> <h3 id="iaccount-interface"><a href="#iaccount-interface" class="header-anchor">#</a> IAccount interface</h3> <p>Each account is recommended to implement the <a href="https://github.com/matter-labs/v2-testnet-contracts/blob/main/l2/system-contracts/interfaces/IAccount.sol" target="_blank" rel="noopener noreferrer">IAccount<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> interface. It contains the following five methods:</p> <ul><li><code>validateTransaction</code> is mandatory and will be used by the system to determine if the AA logic agrees to proceed with the transaction. In case the transaction is not accepted (e.g. the signature is wrong) the method should revert. In case the call to this method succeedes, the implemented account logic is considered to accept the transaction, and the system will proceed with the transaction flow.</li> <li><code>executeTransaction</code> is mandatory and will be called by the system after the fee is charged from the user. This function should perform the execution of the transaction.</li> <li><code>payForTransaction</code> is optional and will be called by the system if the transaction has no paymaster, i.e. the account is willing to pay for the transaction. This method should be used to pay for the fees by the account. Note, that if your account will never pay any fees and will always rely on the <a href="#paymasters">paymaster</a> feature, you don't have to implement this method. This method must send at least <code>tx.gasprice * tx.ergsLimit</code> ETH to the <a href="/dev/developer-guides/contracts/system-contracts.html#bootloader">bootloader</a> address.</li> <li><code>prePaymaster</code> is optional and will be called by the system if the transaction has a paymaster, i.e. there is a different address that pays the transaction fees for the user. This method should be used to prepare for the interaction with the paymaster. One of the notable <a href="#approval-based-paymaster-flow">examples</a> where it can be helpful is to approve the ERC-20 tokens for the paymaster.</li> <li><code>executeTransactionFromOutside</code>, technically, is not mandatory, but it is <em>highly encouraged</em>, since there needs to be some way, in case of priority mode (e.g. if the operator is unresponsive), to be able to start transactions from your account from ``outside'' (basically this is the fallback to the standard Ethereum approach, where an EOA starts transaction from your smart contract).</li></ul> <h3 id="ipaymaster-interface"><a href="#ipaymaster-interface" class="header-anchor">#</a> IPaymaster interface</h3> <p>Like in EIP4337, our account abstraction protocol supports paymasters: accounts that can compensate for other accounts' transactions execution. You can read more about them
<a href="#paymasters">here</a>.</p> <p>Each paymaster should implement the <a href="https://github.com/matter-labs/v2-testnet-contracts/blob/main/l2/system-contracts/interfaces/IPaymaster.sol" target="_blank" rel="noopener noreferrer">IPaymaster<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> interface. It contains the following two methods:</p> <ul><li><code>validateAndPayForPaymasterTransaction</code> is mandatory and will be used by the system to determine if the paymaster approves paying for this transaction. If the paymaster is willing to pay for the transaction, this method must send at least <code>tx.gasprice * tx.ergsLimit</code> to the operator. It should return the <code>context</code> that will be one of the call parameters to the <code>postOp</code> method.</li> <li><code>postOp</code> is optional and will be called after the transaction has been executed. Note that unlike EIP4337, there <em>is no guarantee that this method will be called</em>. In particular, this method won't be called if the transaction has failed with <code>out of gas</code> error. It takes four parameters: the context returned by the <code>validateAndPayForPaymasterTransaction</code> method, the transaction itself, whether the execution of the transaction succeeded, and also the maximum amount of ergs the paymaster might be refunded with. More documentation on refunds will be available once their support is added to zkSync.</li></ul> <h3 id="reserved-fields-of-the-transaction-struct-with-special-meaning"><a href="#reserved-fields-of-the-transaction-struct-with-special-meaning" class="header-anchor">#</a> Reserved fields of the <code>Transaction</code> struct with special meaning</h3> <p>Note that each of the methods above accept the <a href="https://github.com/matter-labs/v2-testnet-contracts/blob/0e1c95969a2f92974370326e4430f03e417b25e7/l2/system-contracts/TransactionHelper.sol#L15" target="_blank" rel="noopener noreferrer">Transaction<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> struct.
While some of its fields are self-explanatory, there are also 6 <code>reserved</code> fields, the meaning of each is defined by the transaction's type. We decided to not give these fields names, since they might be unneeded in some future transaction types. For now, the convention is:</p> <ul><li><code>reserved[0]</code> is the nonce.</li> <li><code>reserved[1]</code> is <code>msg.value</code> that should be passed with the transaction.</li></ul> <h3 id="the-transaction-flow"><a href="#the-transaction-flow" class="header-anchor">#</a> The transaction flow</h3> <p>Each transaction goes through the following flow:</p> <h4 id="the-validation-step"><a href="#the-validation-step" class="header-anchor">#</a> The validation step</h4> <p>During the validation step, the account should decide whether it accepts the transaction and if so, pay the fees for it. If any part of the validation fails, the account is not charged a fee, and such transaction can not be included in a block.</p> <p><strong>Step 1.</strong> The system checks that the nonce of the transaction has not been used before. You can read more about preserving the nonce uniqueness <a href="#keeping-nonces-unique">here</a>.</p> <p><strong>Step 2.</strong> The system calls the <code>validateTransaction</code> method of the account. If it does not revert, proceed to the next step.</p> <p><strong>Step 3.</strong> The system checks that the nonce of the transaction has been marked as used.</p> <p><strong>Step 4 (no paymaster).</strong> The system calls the <code>payForTransaction</code> method of the account. If it does not revert, proceed to the next step.</p> <p><strong>Step 4 (paymaster).</strong> The system calls the <code>prePaymaster</code> method of the sender. If this call does not revert, then the <code>validateAndPayForPaymasterTransaction</code> method of the paymaster is called. If it does not revert too, proceed to the next step.</p> <p><strong>Step 5.</strong> The system verifies that the bootloader has received at least <code>tx.ergsPrice * tx.ergsLimit</code> ETH to the bootloader. If it is the case, the verification is considered
complete and we can proceed to the next step.</p> <h4 id="the-execution-step"><a href="#the-execution-step" class="header-anchor">#</a> The execution step</h4> <p>The execution step is considered responsible for the actual execution of the transaction and sending the refunds for any unused ergs back to the user. If there is any revert on this step, the transaction is still considered valid and will be included in the block.</p> <p><strong>Step 6.</strong> The system calls the <code>executeTransaction</code> method of the account.</p> <p><strong>Step 7. (only in case the transaction has a paymaster)</strong> The <code>postOp</code> method of the paymaster is called. This step should typically be used for refunding the sender the
unused ergs in case the paymaster was used to facilitate paying fees in ERC-20 tokens.</p> <h3 id="fees"><a href="#fees" class="header-anchor">#</a> Fees</h3> <p>In EIP4337 you can see three types of gas limits: <code>verificationGas</code>, <code>executionGas</code>, <code>preVerificationGas</code>, that describe the gas limit for the different steps of the transaction inclusion in a block.
zkSync 2 has only a single field, <code>ergsLimit</code>, that covers the fee for all three. When submitting a transaction, make sure that <code>ergsLimit</code> is enough to cover verification,
paying the fee (the ERC20 transfer mentioned above), and the actual execution itself.</p> <p>By default, calling <code>estimateGas</code> adds a constant to cover charging the fee and the signature verification for EOA accounts.</p> <h2 id="using-the-systemcontractscaller-library"><a href="#using-the-systemcontractscaller-library" class="header-anchor">#</a> Using the <code>SystemContractsCaller</code> library</h2> <p>For the sake of security, both <code>NonceHolder</code> and the <code>ContractDeployer</code> system contracts can only be called with a special <code>isSystem</code> flag. You can read more about it <a href="/dev/developer-guides/contracts/system-contracts.html#protected-access-to-some-of-the-system-contracts">here</a>. To make a call with this flag, the <code>systemCall</code> method of the <a href="https://github.com/matter-labs/v2-testnet-contracts/blob/sb-system-contracts-for-new-update/l2/system-contracts/SystemContractsCaller.sol" target="_blank" rel="noopener noreferrer">SystemContractsCaller<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> library should be used.</p> <p>Using this library is practically a must when developing custom accounts since this is the only way to call non-view methods of the <code>NonceHolder</code> system contract. Also, you will have to use this library if you want to allow users to deploy contracts of their own. You can use the <a href="https://github.com/matter-labs/v2-testnet-contracts/blob/sb-system-contracts-for-new-update/l2/system-contracts/DefaultAccount.sol" target="_blank" rel="noopener noreferrer">implementation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> of the EOA account as a reference.</p> <h2 id="extending-eip4337"><a href="#extending-eip4337" class="header-anchor">#</a> Extending EIP4337</h2> <p>To provide DoS protection for the operator, EIP4337 imposes several <a href="https://eips.ethereum.org/EIPS/eip-4337#simulation" target="_blank" rel="noopener noreferrer">restrictions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> on the validation step of the account.
Most of them, especially those regarding the forbidden opcodes, are still relevant. However, several restrictions have been lifted for better UX.</p> <h3 id="extending-the-allowed-opcodes"><a href="#extending-the-allowed-opcodes" class="header-anchor">#</a> Extending the allowed opcodes</h3> <ul><li>It is allowed to <code>call</code>/<code>delegateCall</code>/<code>staticcall</code> contracts that were already deployed. Unlike Ethereum, we have no way to edit the code that was deployed or delete the contract via selfdestruct, so we can be sure that the code during the execution of the contract will be the same.</li></ul> <h3 id="extending-the-set-of-slots-that-belong-to-a-user"><a href="#extending-the-set-of-slots-that-belong-to-a-user" class="header-anchor">#</a> Extending the set of slots that belong to a user</h3> <p>In the original EIP, the <code>validateTransaction</code> step of the AA allows the account to read only the storage slots of its own. However, there are slots that <em>semantically</em> belong to that user but are actually located on another contract’s addresses. A notable example is <code>ERC20</code> balance.</p> <p>This limitation provides DDoS safety by ensuring that the slots used for validation by various accounts <em>do not overlap</em>, so there is no need for them to <em>actually</em> belong to the account’s storage.</p> <p>To enable reading the user's ERC20 balance or allowance on the validation step, the following types of slots will be allowed for an account with address <code>A</code> on the validation step:</p> <ol><li>Slots that belong to address <code>A</code>.</li> <li>Slots <code>A</code> on any other address.</li> <li>Slots of type <code>keccak256(A || X)</code> on any other address. (to cover <code>mapping(address =&gt; value)</code>, which is usually used for balance in ERC20 tokens).</li> <li>Slots of type <code>keccak256(X || OWN)</code> on any other address, where <code>OWN</code> is some slot of the previous (third) type (to cover <code>mapping(address ⇒ mapping(address ⇒ uint256))</code> that are usually used for <code>allowances</code> in ERC20 tokens).</li></ol> <h3 id="what-could-be-allowed-in-the-future"><a href="#what-could-be-allowed-in-the-future" class="header-anchor">#</a> What could be allowed in the future?</h3> <p>In the future, we might even allow time-bound transactions, e.g. allow checking that <code>block.timestamp &lt;= value</code> if it returned <code>false</code>, etc. This would require deploying a separate library of such trusted methods, but it would greatly increase the capabilities of accounts.</p> <h2 id="building-custom-accounts"><a href="#building-custom-accounts" class="header-anchor">#</a> Building custom accounts</h2> <p>As already mentioned above, each account should implement the <a href="#iaccount-interface">IAccount</a> interface.</p> <p>An example of the implementation of the AA interface is the <a href="https://github.com/matter-labs/v2-testnet-contracts/blob/6a93ff85d33dfff0008624eb9777d5a07a26c55d/l2/system-contracts/DefaultAA.sol#L16" target="_blank" rel="noopener noreferrer">implementation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> of the EOA account.
Note that this account, just like standard EOA accounts on Ethereum, successfully returns empty value whenever it is called by an external address, while this may not be the behaviour that you would like for your account.</p> <h3 id="eip1271"><a href="#eip1271" class="header-anchor">#</a> EIP1271</h3> <p>If you are building a smart wallet, we also <em>highly encourage</em> you to implement the <a href="https://eips.ethereum.org/EIPS/eip-1271" target="_blank" rel="noopener noreferrer">EIP1271<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> signature-validation scheme.
This is the standard that is endorsed by the zkSync team. It is used in the signature-verification library described below in this section.</p> <h3 id="the-deployment-process"><a href="#the-deployment-process" class="header-anchor">#</a> The deployment process</h3> <p>The process of deploying account logic is very similar to the one of deploying a smart contract.
In order to protect smart contracts that do not want to be treated as an account, a different method of the deployer system contract should be used to do it.
Instead of using <code>create</code>/<code>create2</code>, you should use the <code>createAccount</code>/<code>create2Account</code> methods of the deployer system contract.</p> <p>Here is an example of how to deploy account logic using the <code>zksync-web3</code> SDK:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ContractFactory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;zksync-web3&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> contractFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContractFactory</span><span class="token punctuation">(</span>abi<span class="token punctuation">,</span> bytecode<span class="token punctuation">,</span> initiator<span class="token punctuation">,</span> <span class="token string">&quot;createAccount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> aa <span class="token operator">=</span> <span class="token keyword">await</span> contractFactory<span class="token punctuation">.</span><span class="token function">deploy</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> aa<span class="token punctuation">.</span><span class="token function">deployed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="limitations-of-the-verification-step"><a href="#limitations-of-the-verification-step" class="header-anchor">#</a> Limitations of the verification step</h3> <div class="custom-block warning"><p class="custom-block-title">Not implemented yet</p> <p>The verification rules are not fully enforced right now. Even if your custom account works right now, it might stop working in the future if it does not follow the rules below.</p></div> <p>In order to protect the system from a DoS threat, the verification step must have the following limitations:</p> <ul><li>The account logic can only touch slots that belong to the account. Note, that the <a href="#extending-the-set-of-slots-that-belong-to-a-user">definition</a> is far beyond just the slots that are at the users' address.</li> <li>The account logic can not use context variables (e.g. <code>block.number</code>).</li> <li>It is also required that your account increases the nonce by 1. This restriction is only needed to preserve transaction hash collision resistance. In the future, this requirement will be lifted to allow more generic use-cases (e.g. privacy protocols).</li></ul> <p>Transactions that violate the rules above will not be accepted by the API, though these requirements can not be enforced on the circuit/VM level and do not apply to L1-&gt;L2 transactions.</p> <p>To let you try out the feature faster, we decided to release account abstraction publicly before fully implementing the limitations' checks for the verification step of the account.
Currently, your transactions may pass through the API despite violating the requirements above, but soon this will be changed.</p> <h3 id="nonce-holder-contract"><a href="#nonce-holder-contract" class="header-anchor">#</a> Nonce holder contract</h3> <p>For optimization purposes, both <a href="/dev/developer-guides/contracts/contracts.html#differences-in-create-behaviour">tx nonce and the deployment nonce</a> are put in one storage slot inside the <a href="/dev/developer-guides/contracts/system-contracts.html#inonceholder">NonceHolder</a> system contracts.
In order to increment the nonce of your account, it is highly recommended to call the <a href="https://github.com/matter-labs/v2-testnet-contracts/blob/0e1c95969a2f92974370326e4430f03e417b25e7/l2/system-contracts/interfaces/INonceHolder.sol#L10" target="_blank" rel="noopener noreferrer">incrementNonceIfEquals<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> function and pass the value of the nonce provided in the transaction.</p> <p>This is one of the whitelisted calls, where the account logic is allowed to call outside smart contracts.</p> <h3 id="sending-transactions-from-an-account"><a href="#sending-transactions-from-an-account" class="header-anchor">#</a> Sending transactions from an account</h3> <p>For now, only EIP712 transactions are supported. To submit a transaction from a specific account, you should provide the <code>from</code> field of the transaction as the address of the sender and the <code>customSignature</code> field of the <code>customData</code> with the signature for the account.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> utils <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;zksync-web3&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// here the `tx` is a `TransactionRequest` object from `zksync-web3` SDK.</span>
<span class="token comment">// and the zksyncProvider is the `Provider` object from `zksync-web3` SDK connected to zkSync network.</span>
tx<span class="token punctuation">.</span>from <span class="token operator">=</span> aaAddress<span class="token punctuation">;</span>
tx<span class="token punctuation">.</span>customData <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>tx<span class="token punctuation">.</span>customData<span class="token punctuation">,</span>
  customSignature<span class="token operator">:</span> aaSignature<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> serializedTx <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>tx <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> sentTx <span class="token operator">=</span> <span class="token keyword">await</span> zksyncProvider<span class="token punctuation">.</span><span class="token function">sendTransaction</span><span class="token punctuation">(</span>serializedTx<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="paymasters"><a href="#paymasters" class="header-anchor">#</a> Paymasters</h2> <p>Imagine being able to pay fees for users of your protocol! Paymasters are accounts that can compensate for other accounts' transactions. The other important use-case of
paymasters is to facilitate paying fees in ERC20 tokens. While ETH is the formal fee token in zkSync, paymasters can provide the ability to exchange ERC20 tokens to ETH on the fly.</p> <p>If users want to interact with a paymaster, they should provide the non-zero <code>paymaster</code> address in their EIP712 transaction. The input data to the paymaster is provided in the <code>paymasterInput</code> field of the paymaster.</p> <h3 id="paymaster-verification-rules"><a href="#paymaster-verification-rules" class="header-anchor">#</a> Paymaster verification rules</h3> <div class="custom-block warning"><p class="custom-block-title">Not implemented yet</p> <p>The verification rules are not fully enforced right now. Even if your paymaster works right now, it might stop working in the future if it does not follow the rules below.</p></div> <p>Since multiple users should be allowed to access the same paymaster, malicious paymasters <em>can</em> do a DoS attack on our system. To work around this, a system similar to the <a href="https://eips.ethereum.org/EIPS/eip-4337#reputation-scoring-and-throttlingbanning-for-paymasters" target="_blank" rel="noopener noreferrer">EIP4337 reputation scoring<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> will be used.</p> <p>Unlike in the original EIP, paymasters are allowed to touch any storage slots. Also, the paymaster won't be throttled if either of the following is true:</p> <ul><li>More than <code>X</code> minutes have passed since the verification has passed on the API nodes (the exact value of <code>X</code> will be defined later).</li> <li>The order of slots being read is the same as during the run on the API node and the first slot whose value has changed is one of the user's slots. This is needed to protect the paymaster from malicious users (e.g. the user might have erased the allowance for the ERC20 token).</li></ul> <h3 id="built-in-paymaster-flows"><a href="#built-in-paymaster-flows" class="header-anchor">#</a> Built-in paymaster flows</h3> <p>While some paymasters can trivially operate without any interaction from users (e.g. a protocol that always pays fees for their users), some require active participation from the transaction's sender. A notable example is a paymaster that swaps users' ERC20 tokens to ETH as it requires the user to set the necessary allowance to the paymaster.</p> <p>The account abstraction protocol by itself is generic and allows both accounts and paymasters to implement arbitrary interactions. However, the code of default accounts (EOAs) is constant, but we still want them to be able to participate in the ecosystem of custom accounts and paymasters. That's why we have standardized the <code>paymasterInput</code> field of the transaction to cover the most common uses-cases of the paymaster feature.</p> <p>Your accounts are free to implement or not implement the support for these flows. However, this is highly encouraged to keep the interface the same for both EOAs and custom accounts.</p> <h4 id="general-paymaster-flow"><a href="#general-paymaster-flow" class="header-anchor">#</a> General paymaster flow</h4> <p>It should be used if no prior actions are required from the user for the paymaster to operate.</p> <p>The <code>paymasterInput</code> field must be encoded as a call to a function with the following interface:</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">general</span><span class="token punctuation">(</span><span class="token builtin">bytes</span> <span class="token keyword">calldata</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>EOA accounts will do nothing and the paymaster can interpret this <code>data</code> in any way.</p> <h4 id="approval-based-paymaster-flow"><a href="#approval-based-paymaster-flow" class="header-anchor">#</a> Approval-based paymaster flow</h4> <p>It should be used if the user is required to set certain allowance to a token for the paymaster to operate. The <code>paymasterInput</code> field must be encoded as a call to a function with the following signature:</p> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">function</span> <span class="token function">approvalBased</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> _token<span class="token punctuation">,</span>
    <span class="token builtin">uint256</span> _minAllowance<span class="token punctuation">,</span>
    <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> _innerInput
<span class="token punctuation">)</span>
</code></pre></div><p>The EOA will ensure that the allowance of the <code>_token</code> towards the paymaster is set to at least <code>_minAllowance</code>. The <code>_innerInput</code> param is an additional payload that can be sent to the paymaster to implement any logic (e.g. an additional signature or key that can be validated by the paymaster).</p> <p>If you are developing a paymaster, you <em>should not</em> trust the transaction sender to behave honestly (e.g. provide the required allowance with the <code>approvalBased</code> flow). These flows serve mostly as instructions to EOAs and the requirements should always be double-checked by the paymaster.</p> <h4 id="working-with-paymaster-flows-using-zksync-web3-sdk"><a href="#working-with-paymaster-flows-using-zksync-web3-sdk" class="header-anchor">#</a> Working with paymaster flows using <code>zksync-web3</code> SDK</h4> <p>The <code>zksync-web3</code> SDK provides <a href="/api/js/utils.html#encoding-paymaster-param">methods</a> for encoding correctly formatted paymaster params for all of the built-in paymaster flows.</p> <h3 id="testnet-paymaster"><a href="#testnet-paymaster" class="header-anchor">#</a> Testnet paymaster</h3> <p>To ensure users experience paymasters on testnet, as well as keep supporting paying fees in ERC20 tokens, the Matter Labs team provides the testnet paymaster, that enables paying fees in ERC20 token at a 1:1 exchange rate with ETH (i.e. one unit of this token is equal to 1 wei of ETH).</p> <p>The paymaster supports only the <a href="#approval-based-paymaster-flow">approval based</a> paymaster flow and requires that the <code>token</code> param is equal to the token being swapped and <code>minAllowance</code> to equal to least <code>tx.maxFeePerErg * tx.ergsLimit</code>. In addition, the testnet paymaster does not make use of the <code>_innerInput</code> parameter, so nothing should be provided (empty <code>bytes</code>).</p> <p>An example of how to use testnet paymaster can be seen in the <a href="/dev/developer-guides/hello-world.html#paying-fees-using-testnet-paymaster">quickstart</a> tutorial.</p> <h2 id="aa-signature-checker"><a href="#aa-signature-checker" class="header-anchor">#</a> <code>aa-signature-checker</code></h2> <p>Your project can start preparing for native AA support. We highly encourage you to do so, since it will allow you to onboard hundreds of thousands of users (e.g. Argent users that already use the first version of zkSync).
We expect that in the future even more users will switch to smart wallets.</p> <p>One of the most notable differences between various types of accounts to be built is different signature schemes. We expect accounts to support the <a href="https://eips.ethereum.org/EIPS/eip-1271" target="_blank" rel="noopener noreferrer">EIP-1271<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> standard. Our team has created a utility library for verifying account signatures. Currently, it only supports ECDSA signatures, but we will add support for EIP-1271 very soon as well.</p> <p>The <code>aa-signature-checker</code> library provides a way to verify signatures for different account implementations. Currently it only supports verifying ECDSA signatures. Very soon we will add support for EIP-1271 as well.</p> <p><em>We strongly encourage you to use this library whenever you need to check that a signature of an account is correct.</em></p> <h3 id="adding-the-library-to-your-project"><a href="#adding-the-library-to-your-project" class="header-anchor">#</a> Adding the library to your project:</h3> <div class="language- extra-class"><pre class="language-text"><code>yarn add @matterlabs/signature-checker
</code></pre></div><h3 id="example-of-using-the-library"><a href="#example-of-using-the-library" class="header-anchor">#</a> Example of using the library</h3> <div class="language-solidity extra-class"><pre class="language-solidity"><code><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.0</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> SignatureChecker <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@matterlabs/signature-checker/contracts/SignatureChecker.sol&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">contract</span> <span class="token class-name">TestSignatureChecker</span> <span class="token punctuation">{</span>
    <span class="token keyword">using</span> <span class="token class-name">SignatureChecker</span> <span class="token keyword">for</span> <span class="token builtin">address</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">isValidSignature</span><span class="token punctuation">(</span>
        <span class="token builtin">address</span> _address<span class="token punctuation">,</span>
        <span class="token builtin">bytes32</span> _hash<span class="token punctuation">,</span>
        <span class="token builtin">bytes</span> <span class="token keyword">memory</span> _signature
    <span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _address<span class="token punctuation">.</span><span class="token function">checkSignature</span><span class="token punctuation">(</span>_hash<span class="token punctuation">,</span> _signature<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="verifying-aa-signatures-within-our-sdk"><a href="#verifying-aa-signatures-within-our-sdk" class="header-anchor">#</a> Verifying AA signatures within our SDK</h2> <p>It is also <strong>not recommended</strong> to use <code>ethers.js</code> library to verify user signatures.</p> <p>Our SDK provides two methods with its <code>utils</code> to verify the signature of an account:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">isMessageSignatureCorrect</span><span class="token punctuation">(</span>address<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> message<span class="token operator">:</span> ethers<span class="token punctuation">.</span>Bytes <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">,</span> signature<span class="token operator">:</span> SignatureLike<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">isTypedDataSignatureCorrect</span><span class="token punctuation">(</span>
  address<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  domain<span class="token operator">:</span> TypedDataDomain<span class="token punctuation">,</span>
  types<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>TypedDataField<span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
  value<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  signature<span class="token operator">:</span> SignatureLike
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">boolean</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre></div><p>Currently these methods only support verifying ECDSA signatures, but very soon they will support EIP1271 signature verification as well.</p> <p>Both of these methods return <code>true</code> or <code>false</code> depending on whether the message signature is correct.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/matter-labs/zksync-web-v2-docs/edit/main/docs/dev/developer-guides/aa.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/17/2022, 10:23:42 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/dev/developer-guides/contracts/system-contracts.html" class="prev">
        System contracts
      </a></span> <span class="next"><a href="/dev/developer-guides/security.html">
        Security model
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c6cf46ce.js" defer></script><script src="/assets/js/2.5a73362d.js" defer></script><script src="/assets/js/45.e4e94522.js" defer></script>
  </body>
</html>
